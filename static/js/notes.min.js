!function(){"use strict";const t={sidebarOpen:!1,viewportWidth:window.innerWidth,isMobile:window.innerWidth<768,touchState:{startX:0,startY:0,currentX:0,currentY:0,startTime:0,endTime:0,isSwiping:!1},clickSuppressed:!1,STORAGE_KEY:"mobileUIState",init:function(){this.viewportWidth=window.innerWidth,this.isMobile=this.viewportWidth<768;try{const t=localStorage.getItem(this.STORAGE_KEY);if(t){const e=JSON.parse(t);this.sidebarOpen=e.sidebarOpen||!1}else this.isMobile?(this.sidebarOpen=!0,console.log("First visit on mobile: opening sidebar by default"),this.syncDOM(),setTimeout(()=>{this.sidebarOpen=!1,this.syncDOM(),this.persist(),this.showMobileHint()},3e3)):this.sidebarOpen=!1}catch(t){console.warn("Failed to load saved UI state:",t),this.sidebarOpen=!1}this.syncDOM(),this.initTouchEvents(),this.initVirtualViewport(),console.log("MobileUIState initialized:",this.getState())},getState:function(){return{sidebarOpen:this.sidebarOpen,viewportWidth:this.viewportWidth,isMobile:this.isMobile}},toggleSidebar:function(){this.sidebarOpen=!this.sidebarOpen,this.syncDOM(),this.persist(),console.log("Sidebar toggled:",this.sidebarOpen)},updateViewport:function(){const t=this.isMobile;this.viewportWidth=window.innerWidth,this.isMobile=this.viewportWidth<768,t&&!this.isMobile?this.sidebarOpen||(this.sidebarOpen=!0,console.log("Desktop mode: auto-opening sidebar")):!t&&this.isMobile&&(this.sidebarOpen=!1,console.log("Mobile mode: closing sidebar")),this.syncDOM(),this.persist()},syncDOM:function(){const t=document.getElementById("sidebar");if(!t)return;this.isMobile?(t.classList.remove("collapsed"),this.sidebarOpen?t.classList.add("mobile-open"):t.classList.remove("mobile-open")):(t.classList.remove("mobile-open"),this.sidebarOpen?t.classList.remove("collapsed"):t.classList.add("collapsed"));const e=document.getElementById("sidebarToggleText");e&&(e.textContent=this.sidebarOpen?"\u6536\u8d77\u4fa7\u8fb9\u680f":"\u5c55\u5f00\u4fa7\u8fb9\u680f")},persist:function(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify({sidebarOpen:this.sidebarOpen}))}catch(t){console.warn("Failed to persist UI state:",t)}},initTouchEvents:function(){const t=document.getElementById("sidebar");t&&(t.addEventListener("touchstart",t=>{const e=t.touches[0];this.touchState.startX=e.clientX,this.touchState.startY=e.clientY,this.touchState.currentX=e.clientX,this.touchState.currentY=e.clientY,this.touchState.startTime=Date.now(),this.touchState.isSwiping=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(0===t.touches.length)return;const e=t.touches[0];this.touchState.currentX=e.clientX,this.touchState.currentY=e.clientY,this.touchState.isSwiping=!0},{passive:!0}),t.addEventListener("touchend",t=>{this.touchState.endTime=Date.now(),this.handleSwipeGesture()},{passive:!0}),console.log("Touch event listeners initialized for sidebar"))},handleSwipeGesture:function(){if(!this.isMobile||!this.sidebarOpen||!this.touchState.isSwiping)return void(this.touchState.isSwiping=!1);const t=this.touchState.currentX-this.touchState.startX,e=this.touchState.currentY-this.touchState.startY,n=this.touchState.endTime-this.touchState.startTime,i=Math.abs(t)/n;Math.abs(t)>Math.abs(e)&&(t<-50||i>.3&&t<0)&&(console.log(`Swipe detected: deltaX=${t.toFixed(1)}px, velocity=${i.toFixed(3)}px/ms`),this.toggleSidebar(),this.clickSuppressed=!0,setTimeout(()=>{this.clickSuppressed=!1},300)),this.touchState.isSwiping=!1},initVirtualViewport:function(){window.visualViewport?(visualViewport.addEventListener("resize",()=>{const t=visualViewport.height;if(window.innerHeight-t>150){const t=document.activeElement;!t||"TEXTAREA"!==t.tagName&&"INPUT"!==t.tagName||setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},100)}}),console.log("Virtual Viewport API initialized for keyboard handling")):console.log("Visual Viewport API not supported, using fallback")},showMobileHint:function(){console.log("Mobile hint: Sidebar can be toggled using the menu button")}};function e(t,e){let n=0,i=null;return function(){const o=this,s=arguments,c=Date.now();if(i&&(clearTimeout(i),i=null),c-n>=e)n=c,t.apply(o,s);else{i=setTimeout(function(){n=Date.now(),t.apply(o,s)},e-(c-n))}}}const n={connectionType:null,lastDetectionTime:0,CACHE_DURATION:3e4,TIMEOUTS:{"slow-2g":15e3,"2g":1e4,"3g":8e3,"4g":5e3,wifi:5e3,unknown:5e3},RETRY_COUNTS:{"slow-2g":3,"2g":3,"3g":2,"4g":1,wifi:1,unknown:1},detectConnectionType:function(){const t=Date.now();if(this.connectionType&&t-this.lastDetectionTime<this.CACHE_DURATION)return this.connectionType;if(navigator.connection&&navigator.connection.effectiveType){const t=navigator.connection.effectiveType;"wifi"===navigator.connection.type?this.connectionType="wifi":this.connectionType=t}else this.connectionType="4g";return this.lastDetectionTime=t,this.connectionType},getApiTimeout:function(){const t=this.detectConnectionType();return this.TIMEOUTS[t]||this.TIMEOUTS.unknown},getRetryCount:function(){const t=this.detectConnectionType();return this.RETRY_COUNTS[t]||this.RETRY_COUNTS.unknown},isOnline:function(){return navigator.onLine},fetchWithRetry:async function(t,e={},n=null){if(!this.isOnline())throw new Error("\u7f51\u7edc\u8fde\u63a5\u4e0d\u53ef\u7528,\u8bf7\u68c0\u67e5\u60a8\u7684\u7f51\u7edc\u8bbe\u7f6e");const i=this.getApiTimeout(),o=null!==n?n:this.getRetryCount();for(let n=0;n<=o;n++)try{const n=new AbortController,o=setTimeout(()=>n.abort(),i),s={...e,signal:n.signal},c=await fetch(t,s);if(clearTimeout(o),c.status>=400&&c.status<500)return c;if(c.ok)return c;throw new Error(`HTTP ${c.status}: ${c.statusText}`)}catch(t){const e=n===o;if("AbortError"===t.name){if(console.log(`\u8bf7\u6c42\u8d85\u65f6 (\u5c1d\u8bd5 ${n+1}/${o+1})`),!e){const t=Math.min(1e3*Math.pow(2,n),1e4);console.log(`\u7b49\u5f85 ${t}ms \u540e\u91cd\u8bd5...`),await this.sleep(t);continue}throw new Error(`\u8bf7\u6c42\u8d85\u65f6 (${i}ms),\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5`)}if(t instanceof TypeError){if(console.log(`\u7f51\u7edc\u9519\u8bef (\u5c1d\u8bd5 ${n+1}/${o+1})`),!e){const t=Math.min(1e3*Math.pow(2,n),1e4);console.log(`\u7b49\u5f85 ${t}ms \u540e\u91cd\u8bd5...`),await this.sleep(t);continue}throw new Error("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25,\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5")}throw t}},sleep:function(t){return new Promise(e=>setTimeout(e,t))},init:function(){window.addEventListener("online",()=>{console.log("\u7f51\u7edc\u5df2\u8fde\u63a5"),this.hideOfflineBanner()}),window.addEventListener("offline",()=>{console.log("\u7f51\u7edc\u5df2\u65ad\u5f00"),this.showOfflineBanner()}),navigator.connection&&navigator.connection.addEventListener("change",()=>{this.connectionType=null,console.log("\u7f51\u7edc\u8fde\u63a5\u7c7b\u578b\u53d8\u66f4:",this.detectConnectionType())}),this.isOnline()||this.showOfflineBanner(),console.log("NetworkManager initialized - Connection:",this.detectConnectionType())},showOfflineBanner:function(){let t=document.getElementById("offlineBanner");t||(t=document.createElement("div"),t.id="offlineBanner",t.style.cssText="\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    background: #f44336;\n                    color: white;\n                    padding: 12px;\n                    text-align: center;\n                    z-index: 10000;\n                    font-size: 14px;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                ",t.textContent="\u7f51\u7edc\u8fde\u63a5\u4e0d\u53ef\u7528 - \u8bf7\u68c0\u67e5\u60a8\u7684\u7f51\u7edc\u8bbe\u7f6e",document.body.insertBefore(t,document.body.firstChild))},hideOfflineBanner:function(){const t=document.getElementById("offlineBanner");t&&t.remove()}};window.toggleSidebar=function(){t.clickSuppressed||t.toggleSidebar()},window.toggleMobileSidebar=function(){t.clickSuppressed||t.toggleSidebar()},window.toggleTheme=function(){const t=document.documentElement,e=t.getAttribute("data-theme");t.setAttribute("data-theme","dark"===e?"":"dark"),localStorage.setItem("theme","dark"===e?"light":"dark")},window.toggleSearch=function(){const t=document.getElementById("topbarSearch"),e=document.getElementById("topSearchInput");t.classList.contains("active")?t.classList.remove("active"):(t.classList.add("active"),setTimeout(()=>e.focus(),300))},window.toggleFilter=function(){const t=document.getElementById("filterPanel");t&&t.classList.toggle("active")},window.toggleUserMenu=function(){console.log("User menu clicked")},window.toggleText=function(t){const e=document.getElementById("text-"+t),n=document.getElementById("expand-"+t);e.classList.contains("expanded")?(e.classList.remove("expanded"),n.textContent="\u5c55\u5f00\u5168\u6587 \u25bc"):(e.classList.add("expanded"),n.textContent="\u6536\u8d77 \u25b2")},window.openImageModal=function(t){const e=document.getElementById("imageModal"),n=document.getElementById("modalImage");e.classList.add("active"),n.src=t,document.body.style.overflow="hidden"},window.closeImageModal=function(){document.getElementById("imageModal").classList.remove("active"),document.body.style.overflow="auto"};const i=e(function(t,e){n.fetchWithRetry(`/toggle_favorite/${t}`,{method:"POST",headers:{"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{t.success&&(e.classList.toggle("active"),e.textContent=e.classList.contains("active")?"\u2605":"\u2606")}).catch(t=>{console.error("\u6536\u85cf\u64cd\u4f5c\u5931\u8d25:",t),alert("\u6536\u85cf\u64cd\u4f5c\u5931\u8d25: "+t.message)})},1e3);window.toggleFavorite=function(t,e){i(t,e)};const o=e(function(t){confirm("\u786e\u5b9a\u8981\u5220\u9664\u8fd9\u6761\u7b14\u8bb0\u5417?\u6b64\u64cd\u4f5c\u4e0d\u53ef\u64a4\u9500\u3002")&&n.fetchWithRetry(`/delete_note/${t}`,{method:"POST",headers:{"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(!t.success)throw new Error(t.error||"\u5220\u9664\u5931\u8d25");location.reload()}).catch(t=>{console.error("\u5220\u9664\u7b14\u8bb0\u5931\u8d25:",t),alert("\u5220\u9664\u7b14\u8bb0\u5931\u8d25: "+t.message)})},1e3);window.deleteNote=function(t){o(t)};const s=e(function(t,e,i){const o=n.detectConnectionType(),s=Math.ceil(e*("slow-2g"===o||"2g"===o?15:10));if(!confirm(`\u6821\u51c6\u5c06\u5411\u673a\u5668\u4eba\u53d1\u9001 ${e} \u4e2a\u78c1\u529b\u94fe\u63a5,\u9884\u8ba1\u9700\u8981\u7ea6 ${s} \u79d2 (${o} \u8fde\u63a5)\u3002\u786e\u5b9a\u7ee7\u7eed?`))return;i.disabled=!0,i.textContent="\u6821\u51c6\u4e2d...";const c="\u6821\u51c6"+(e>1?"("+e+")":""),a=n.getApiTimeout();Math.min(a*e,6e4);n.fetchWithRetry(`/api/calibrate/${t}`,{method:"POST",headers:{"Content-Type":"application/json"}},2).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).then(t=>{if(!t.success)throw new Error(t.error||"\u672a\u77e5\u9519\u8bef");alert(`\u6821\u51c6\u5b8c\u6210!\n\u603b\u5171: ${t.total}\n\u6210\u529f: ${t.success_count}\n\u5931\u8d25: ${t.fail_count}`),setTimeout(()=>location.reload(),1e3)}).catch(t=>{console.error("\u6821\u51c6\u51fa\u9519:",t),alert("\u6821\u51c6\u5931\u8d25: "+t.message),i.disabled=!1,i.textContent=c})},1e3);window.calibrateNote=function(t,e,n){s(t,e,n)},document.addEventListener("DOMContentLoaded",function(){"dark"===localStorage.getItem("theme")&&document.documentElement.setAttribute("data-theme","dark"),function(){if(!("IntersectionObserver"in window))return void console.warn("IntersectionObserver not supported, loading all images immediately");const t=new IntersectionObserver(function(t,e){t.forEach(function(t){if(t.isIntersecting){const n=t.target;if(n.dataset.src){n.classList.add("image-loading");const t=new Image;t.onload=function(){n.src=n.dataset.src,n.classList.remove("image-loading"),n.classList.add("image-loaded")},t.onerror=function(){n.classList.remove("image-loading"),n.classList.add("image-error")},t.src=n.dataset.src,e.unobserve(n)}}})},{rootMargin:"200px",threshold:.01});document.querySelectorAll('.note-media img[loading="lazy"]').forEach(function(e){e.src&&!e.dataset.src&&(e.dataset.src=e.src,e.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"%3E%3Crect width="400" height="300" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="16" fill="%23999"%3ELoading...%3C/text%3E%3C/svg%3E'),t.observe(e)})}(),document.querySelectorAll(".note-text").forEach(function(t){if(t.scrollHeight>120){const e=t.id.replace("text-",""),n=document.getElementById("expand-"+e);n&&(n.style.display="inline-block")}});const e=document.getElementById("sidebar"),n=document.querySelector(".main-content");e&&n&&n.addEventListener("click",function(e){t.isMobile&&t.sidebarOpen&&(t.sidebarOpen=!1,t.syncDOM(),t.persist())}),t.init();const i=document.getElementById("topSearchInput");if(i){i.addEventListener("keypress",function(t){if("Enter"===t.key){const t=this.value.trim();t&&(window.location.href=`/notes?page=1&search=${encodeURIComponent(t)}`)}});const t=function(t,e){let n=null;return function(){const i=this,o=arguments;n&&clearTimeout(n),n=setTimeout(function(){t.apply(i,o)},e)}}(function(t){const e=t.target.value.trim();e.length>=3&&console.log("Auto-search triggered for:",e)},300);i.addEventListener("input",t)}}),window.addEventListener("resize",function(){t.updateViewport()}),document.addEventListener("keydown",function(t){"Escape"===t.key&&window.closeImageModal()}),n.init()}();