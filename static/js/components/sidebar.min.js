/*** Unified Mobile UI State Management* Version: 1.0*/(function() {'use strict';const MobileUIState = {sidebarOpen: false,viewportWidth: window.innerWidth,isMobile: window.innerWidth < 768,touchState: {startX: 0,startY: 0,currentX: 0,currentY: 0,startTime: 0,endTime: 0,isSwiping: false},clickSuppressed: false,STORAGE_KEY: 'mobileUIState',init: function() {this.viewportWidth = window.innerWidth;this.isMobile = this.viewportWidth < 768;try {const saved = window.StorageManager.getItem(this.STORAGE_KEY, null);if (saved) {if (this.isMobile) {this.sidebarOpen = false;console.log('Mobile mode: sidebar closed by default');} else {this.sidebarOpen = saved.sidebarOpen !== false;console.log('Desktop mode: loaded saved sidebar state:', this.sidebarOpen);}} else {if (this.isMobile) {this.sidebarOpen = false;console.log('First visit on mobile: sidebar closed by default');} else {this.sidebarOpen = true;console.log('First visit on desktop: sidebar open by default');}this.persist();}} catch (e) {console.warn('Failed to load saved UI state:', e);this.sidebarOpen = this.isMobile ? false : true;}this.syncDOM();this.verifyStateSync();this.initTouchEvents();this.initVirtualViewport();if (this.isMobile) {var self = this;setTimeout(function() {self.showMobileHint();}, 1000);}console.log('MobileUIState initialized:', this.getState());},getState: function() {return {sidebarOpen: this.sidebarOpen,viewportWidth: this.viewportWidth,isMobile: this.isMobile};},toggleSidebar: function() {this.sidebarOpen = !this.sidebarOpen;this.syncDOM();this.persist();console.log('Sidebar toggled:', this.sidebarOpen);},updateViewport: function() {const oldIsMobile = this.isMobile;this.viewportWidth = window.innerWidth;this.isMobile = this.viewportWidth < 768;if (oldIsMobile && !this.isMobile) {if (!this.sidebarOpen) {this.sidebarOpen = true;console.log('Desktop mode: auto-opening sidebar');}} else if (!oldIsMobile && this.isMobile) {this.sidebarOpen = false;console.log('Mobile mode: closing sidebar');}this.syncDOM();this.persist();},syncDOM: function() {const sidebar = document.getElementById('sidebar');if (!sidebar) {console.warn('Sidebar element not found, cannot sync DOM');return;}if (this.isMobile) {sidebar.classList.remove('collapsed');if (this.sidebarOpen) {sidebar.classList.add('mobile-open');} else {sidebar.classList.remove('mobile-open');}} else {sidebar.classList.remove('mobile-open');if (this.sidebarOpen) {sidebar.classList.remove('collapsed');} else {sidebar.classList.add('collapsed');}}const toggleText = document.getElementById('sidebarToggleText');if (toggleText) {toggleText.textContent = this.sidebarOpen ? 'æ”¶èµ·ä¾§è¾¹æ ' : 'å±•å¼€ä¾§è¾¹æ ';}console.log('DOM synced - Mode:', this.isMobile ? 'mobile' : 'desktop','Open:', this.sidebarOpen,'Classes:', sidebar.className);},persist: function() {const stateToSave = {sidebarOpen: this.sidebarOpen,timestamp: Date.now()};const success = window.StorageManager.setItem(this.STORAGE_KEY, stateToSave);if (success) {console.log('State persisted to localStorage:', stateToSave);} else {console.error('Failed to persist state to localStorage');}return success;},verifyStateSync: function() {try {const saved = window.StorageManager.getItem(this.STORAGE_KEY, null);if (saved) {const isSync = saved.sidebarOpen === this.sidebarOpen;if (!isSync) {console.warn('State mismatch detected!','Memory:', this.sidebarOpen,'Storage:', saved.sidebarOpen);this.persist();} else {console.log('State verification passed - Memory and storage are in sync');}return isSync;}} catch (e) {console.error('State verification failed:', e);return false;}return true;},initTouchEvents: function() {const sidebar = document.getElementById('sidebar');if (!sidebar) return;sidebar.addEventListener('touchstart', function(e) {const touch = e.touches[0];MobileUIState.touchState.startX = touch.clientX;MobileUIState.touchState.startY = touch.clientY;MobileUIState.touchState.currentX = touch.clientX;MobileUIState.touchState.currentY = touch.clientY;MobileUIState.touchState.startTime = Date.now();MobileUIState.touchState.isSwiping = false;}, { passive: true });sidebar.addEventListener('touchmove', function(e) {if (e.touches.length === 0) return;const touch = e.touches[0];MobileUIState.touchState.currentX = touch.clientX;MobileUIState.touchState.currentY = touch.clientY;MobileUIState.touchState.isSwiping = true;}, { passive: true });sidebar.addEventListener('touchend', function(e) {MobileUIState.touchState.endTime = Date.now();MobileUIState.handleSwipeGesture();}, { passive: true });console.log('Touch event listeners initialized for sidebar');},handleSwipeGesture: function() {if (!this.isMobile || !this.sidebarOpen || !this.touchState.isSwiping) {this.touchState.isSwiping = false;return;}const deltaX = this.touchState.currentX - this.touchState.startX;const deltaY = this.touchState.currentY - this.touchState.startY;const duration = this.touchState.endTime - this.touchState.startTime;const velocity = Math.abs(deltaX) / duration;const isHorizontalSwipe = Math.abs(deltaX) > Math.abs(deltaY);const swipeThreshold = 50;const velocityThreshold = 0.3;const isSwipeLeft = deltaX < -swipeThreshold;const isFastSwipe = velocity > velocityThreshold && deltaX < 0;if (isHorizontalSwipe && (isSwipeLeft || isFastSwipe)) {console.log('Swipe detected: deltaX=' + deltaX.toFixed(1) + 'px, velocity=' + velocity.toFixed(3) + 'px/ms');this.toggleSidebar();this.clickSuppressed = true;setTimeout(function() {MobileUIState.clickSuppressed = false;}, 300);}this.touchState.isSwiping = false;},initVirtualViewport: function() {if (!window.visualViewport) {console.log('Visual Viewport API not supported, using fallback');return;}visualViewport.addEventListener('resize', function() {const viewportHeight = visualViewport.height;const windowHeight = window.innerHeight;const keyboardHeight = windowHeight - viewportHeight;if (keyboardHeight > 150) {const activeElement = document.activeElement;if (activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT')) {setTimeout(function() {activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });}, 100);}}});console.log('Virtual Viewport API initialized for keyboard handling');},showMobileHint: function() {var hintShown = window.StorageManager.getItem('mobileHintShown', false);if (hintShown) {return;}var hint = document.createElement('div');hint.style.cssText = 'position: fixed; top: 70px; left: 50%; transform: translateX(-50%); ' +'background: var(--primary-color); color: white; padding: 12px 20px; ' +'border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); ' +'z-index: 10000; font-size: 14px; max-width: 90%; text-align: center; ' +'animation: slideDown 0.3s ease-out;';hint.innerHTML = 'ğŸ’¡ ç‚¹å‡»å·¦ä¸Šè§’çš„ <strong>â˜°</strong> æŒ‰é’®å¯ä»¥æ‰“å¼€ä¾§è¾¹æ èœå•';var style = document.createElement('style');style.textContent = '@keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }';document.head.appendChild(style);document.body.appendChild(hint);setTimeout(function() {hint.style.animation = 'slideUp 0.3s ease-out';hint.style.opacity = '0';hint.style.transform = 'translateX(-50%) translateY(-20px)';setTimeout(function() {if (hint.parentNode) {hint.parentNode.removeChild(hint);}}, 300);}, 3000);window.StorageManager.setItem('mobileHintShown', true);console.log('Mobile hint displayed');}};window.MobileUIState = MobileUIState;})();