#!/usr/bin/env python3
"""
Telegram Bot Setup Script
è‡ªåŠ¨ç™»å½•å¹¶è·å– Session String çš„è®¾ç½®è„šæœ¬
"""

import os
import json
from pyrogram import Client

# æ•°æ®ç›®å½•é…ç½®
DATA_DIR = os.environ.get('DATA_DIR', '/data/save_restricted_bot')
CONFIG_DIR = os.path.join(DATA_DIR, 'config')


def print_banner():
    """æ‰“å°æ¬¢è¿æ¨ªå¹…"""
    print("=" * 60)
    print("  Telegram Bot è‡ªåŠ¨é…ç½®å·¥å…·")
    print("  Save Restricted Content Bot Setup")
    print("=" * 60)
    print()


def get_input(prompt, default=None):
    """è·å–ç”¨æˆ·è¾“å…¥"""
    if default:
        user_input = input(f"{prompt} (é»˜è®¤: {default}): ").strip()
        return user_input if user_input else default
    else:
        while True:
            user_input = input(f"{prompt}: ").strip()
            if user_input:
                return user_input
            print("âŒ æ­¤é¡¹ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ï¼")


def save_to_env(token, api_id, api_hash, session_string):
    """ä¿å­˜é…ç½®åˆ° .env æ–‡ä»¶"""
    env_content = f"""# Telegram Bot Configuration
# Auto-generated by setup.py

# Your bot token from @BotFather
TOKEN={token}

# Your API ID from my.telegram.org
ID={api_id}

# Your API Hash from my.telegram.org
HASH={api_hash}

# Your session string (auto-generated)
STRING={session_string}
"""
    
    with open('.env', 'w', encoding='utf-8') as f:
        f.write(env_content)
    
    print("âœ… é…ç½®å·²ä¿å­˜åˆ° .env æ–‡ä»¶")


def save_to_config_json(token, api_id, api_hash, session_string):
    """ä¿å­˜é…ç½®åˆ° config.json æ–‡ä»¶"""
    # ç¡®ä¿é…ç½®ç›®å½•å­˜åœ¨
    os.makedirs(CONFIG_DIR, exist_ok=True)
    
    config = {
        "TOKEN": token,
        "ID": api_id,
        "HASH": api_hash,
        "STRING": session_string
    }
    
    config_file = os.path.join(CONFIG_DIR, 'config.json')
    with open(config_file, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=4)
    
    print(f"âœ… é…ç½®å·²ä¿å­˜åˆ° {config_file} æ–‡ä»¶")


def generate_session_string(api_id, api_hash, phone_number):
    """ç”Ÿæˆ Session String"""
    print("\nğŸ“± æ­£åœ¨è¿æ¥åˆ° Telegram...")
    print("â³ è¯·ç¨å€™...")
    
    # åˆ›å»ºä¸´æ—¶å®¢æˆ·ç«¯ç”¨äºç™»å½•
    app = Client(
        "temp_session",
        api_id=api_id,
        api_hash=api_hash,
        phone_number=phone_number
    )
    
    try:
        with app:
            # å¯¼å‡º session string
            session_string = app.export_session_string()
            print("âœ… Session String ç”ŸæˆæˆåŠŸï¼")
            return session_string
    except Exception as e:
        print(f"âŒ ç”Ÿæˆå¤±è´¥: {e}")
        return None
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if os.path.exists("temp_session.session"):
            os.remove("temp_session.session")


def main():
    """ä¸»å‡½æ•°"""
    print_banner()
    
    print("æ­¤å·¥å…·å°†å¸®åŠ©æ‚¨è‡ªåŠ¨é…ç½® Telegram Bot")
    print("æ‚¨éœ€è¦å‡†å¤‡ä»¥ä¸‹ä¿¡æ¯ï¼š")
    print("  1. Bot Token (ä» @BotFather è·å–)")
    print("  2. API ID å’Œ API Hash (ä» https://my.telegram.org è·å–)")
    print("  3. æ‚¨çš„æ‰‹æœºå· (ç”¨äºç™»å½• Telegram)")
    print()
    
    # æ­¥éª¤ 1: è·å– Bot Token
    print("ğŸ“‹ æ­¥éª¤ 1/4: Bot Token")
    print("-" * 60)
    print("è¯·è®¿é—® @BotFather åˆ›å»ºä¸€ä¸ª Botï¼Œå¹¶è·å– Token")
    print("Token æ ¼å¼ç¤ºä¾‹: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz")
    bot_token = get_input("è¯·è¾“å…¥ Bot Token")
    print()
    
    # æ­¥éª¤ 2: è·å– API å‡­æ®
    print("ğŸ“‹ æ­¥éª¤ 2/4: API å‡­æ®")
    print("-" * 60)
    print("è¯·è®¿é—® https://my.telegram.org è·å– API ID å’Œ API Hash")
    api_id = get_input("è¯·è¾“å…¥ API ID (çº¯æ•°å­—)")
    api_hash = get_input("è¯·è¾“å…¥ API Hash (32ä½å­—ç¬¦)")
    print()
    
    # æ­¥éª¤ 3: è¯¢é—®æ˜¯å¦éœ€è¦ Session String
    print("ğŸ“‹ æ­¥éª¤ 3/4: Session String (ç”¨æˆ·ä¼šè¯)")
    print("-" * 60)
    print("Session String ç”¨äºè®¿é—®ç§æœ‰é¢‘é“å’Œå—é™å†…å®¹")
    print("å¦‚æœåªéœ€è¦è½¬å‘å…¬å¼€å†…å®¹ï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤")
    need_session = get_input("æ˜¯å¦éœ€è¦ç”Ÿæˆ Session String? (y/n)", "y").lower()
    
    session_string = ""
    
    if need_session in ['y', 'yes', 'æ˜¯']:
        print()
        print("ğŸ“± å¼€å§‹ç™»å½• Telegram è´¦å·...")
        print("-" * 60)
        print("è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ï¼ˆå¸¦å›½å®¶ä»£ç ï¼‰")
        print("ç¤ºä¾‹: +8613800138000")
        phone_number = get_input("æ‰‹æœºå·")
        
        print()
        print("æ­£åœ¨ç”Ÿæˆ Session String...")
        print("âš ï¸  æ³¨æ„: Telegram ä¼šå‘æ‚¨çš„è´¦å·å‘é€éªŒè¯ç ")
        print()
        
        session_string = generate_session_string(api_id, api_hash, phone_number)
        
        if not session_string:
            print()
            print("âš ï¸  Session String ç”Ÿæˆå¤±è´¥ï¼Œä½†æ‚¨ä»å¯ç»§ç»­é…ç½®")
            print("   Bot å°†åªèƒ½è®¿é—®å…¬å¼€å†…å®¹")
            retry = get_input("æ˜¯å¦é‡è¯•? (y/n)", "n").lower()
            if retry in ['y', 'yes', 'æ˜¯']:
                session_string = generate_session_string(api_id, api_hash, phone_number)
    else:
        print("â­ï¸  å·²è·³è¿‡ Session String ç”Ÿæˆ")
        print("   Bot å°†åªèƒ½è®¿é—®å…¬å¼€å†…å®¹")
    
    print()
    
    # æ­¥éª¤ 4: ä¿å­˜é…ç½®
    print("ğŸ“‹ æ­¥éª¤ 4/4: ä¿å­˜é…ç½®")
    print("-" * 60)
    
    # åŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ªæ–‡ä»¶
    save_to_env(bot_token, api_id, api_hash, session_string)
    save_to_config_json(bot_token, api_id, api_hash, session_string)
    
    print()
    print("=" * 60)
    print("âœ… é…ç½®å®Œæˆï¼")
    print("=" * 60)
    print()
    print("ä¸‹ä¸€æ­¥:")
    print("  â€¢ å¦‚æœä½¿ç”¨ Docker: è¿è¡Œ docker-compose up -d")
    print("  â€¢ å¦‚æœæœ¬åœ°è¿è¡Œ: è¿è¡Œ python main.py")
    print()
    print("æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md")
    print()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâš ï¸  è®¾ç½®å·²å–æ¶ˆ")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        print("è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ‰‹åŠ¨é…ç½® .env æ–‡ä»¶")
