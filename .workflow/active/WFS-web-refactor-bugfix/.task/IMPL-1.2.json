{
  "id": "IMPL-1.2",
  "title": "提取notes.html内联JavaScript到独立文件",
  "status": "completed",
  "meta": {
    "agent": "code-developer",
    "type": "refactor",
    "priority": "P0",
    "estimated_hours": 2,
    "execution_group": "phase-1-separation",
    "phase": "Phase 1: 代码分离"
  },
  "context": {
    "objective": "将templates/notes.html中的内联JavaScript (行1015-1840) 提取到独立的JS文件static/js/notes.js，保持所有功能正常工作",
    "background": "notes.html包含840行内联JavaScript代码，包含复杂的UI状态管理、网络请求、事件处理等逻辑。需要提取到独立文件以提升代码可维护性和可测试性。",
    "deliverables": [
      "创建static/js/notes.js文件，包含所有提取的JavaScript代码",
      "更新templates/notes.html，移除内联JS，添加外部JS引用",
      "确保所有JavaScript功能正常工作",
      "添加JS文件版本号支持缓存控制"
    ],
    "acceptance_criteria": [
      "notes.html中的<script>标签已完全移除(除必要的内联配置)",
      "static/js/notes.js文件创建成功，包含所有JS代码",
      "所有页面功能正常：搜索、筛选、分页、收藏、删除等",
      "移动端侧边栏、手势、主题切换等功能正常",
      "无JavaScript错误，控制台无报错"
    ],
    "constraints": [
      "不能修改任何函数的逻辑",
      "必须保持全局变量和函数的可访问性",
      "不能破坏事件监听器的绑定",
      "必须保持DOMContentLoaded事件的执行顺序"
    ],
    "technical_notes": [
      "内联JS位置: templates/notes.html 行1015-1840",
      "包含MobileUIState对象(250+行)、NetworkManager对象(200+行)",
      "使用了localStorage、Intersection Observer、Visual Viewport API",
      "需要注意DOM元素的引用时机(DOMContentLoaded)"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "read_source_file",
        "description": "读取templates/notes.html，定位内联JavaScript部分",
        "command": "Read templates/notes.html offset=1015",
        "expected_output": "获取行1015-1840的完整JavaScript代码"
      },
      {
        "step": "analyze_js_structure",
        "description": "分析JavaScript结构，识别全局变量、函数、事件监听",
        "command": "分析JS代码的依赖关系和执行顺序",
        "expected_output": "JS函数清单和依赖关系图"
      },
      {
        "step": "identify_dom_dependencies",
        "description": "识别DOM元素依赖",
        "command": "查找所有document.getElementById等DOM操作",
        "expected_output": "DOM依赖清单"
      }
    ],
    "implementation": [
      {
        "step": "create_notes_js",
        "description": "创建static/js/notes.js文件",
        "command": "Write static/js/notes.js",
        "expected_output": "包含所有提取JavaScript的新文件"
      },
      {
        "step": "wrap_in_iife",
        "description": "使用IIFE包装代码，避免全局污染",
        "command": "将代码包装在(function() { ... })()中",
        "expected_output": "模块化的JavaScript代码"
      },
      {
        "step": "update_notes_html",
        "description": "更新notes.html，移除内联JS，添加外部引用",
        "command": "Edit templates/notes.html",
        "expected_output": "精简的HTML文件，包含<script>标签"
      },
      {
        "step": "add_version_control",
        "description": "添加JS文件版本号",
        "command": "在<script>标签中添加?v=参数",
        "expected_output": "<script src=\"/static/js/notes.js?v=1.0\"></script>"
      }
    ],
    "verification": [
      {
        "step": "function_test",
        "description": "测试所有JavaScript功能",
        "command": "在浏览器中测试搜索、筛选、分页、收藏、删除等功能",
        "expected_output": "所有功能正常工作"
      },
      {
        "step": "mobile_test",
        "description": "测试移动端功能",
        "command": "测试侧边栏切换、手势滑动、虚拟键盘适配",
        "expected_output": "移动端功能正常"
      },
      {
        "step": "console_check",
        "description": "检查浏览器控制台",
        "command": "打开浏览器开发者工具，查看Console",
        "expected_output": "无JavaScript错误"
      },
      {
        "step": "network_test",
        "description": "测试网络请求功能",
        "command": "测试收藏、删除、校准等API调用",
        "expected_output": "网络请求正常，重试机制工作"
      }
    ]
  },
  "dependencies": {
    "depends_on": ["IMPL-1.1"],
    "blocks": ["IMPL-1.3", "IMPL-2.1"]
  },
  "files": {
    "input": [
      "templates/notes.html"
    ],
    "output": [
      "static/js/notes.js",
      "templates/notes.html"
    ],
    "backup": [
      "templates/notes.html.bak"
    ]
  }
}
