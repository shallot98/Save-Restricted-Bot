# 新功能说明 / New Features

## 功能概览 / Overview

本次更新为机器人添加了以下重要功能：

1. **正则表达式过滤** - 支持使用正则表达式进行消息过滤
2. **提取模式** - 可以从消息中提取特定内容后转发
3. **监控任务编辑** - 可以随时编辑已创建的监控任务
4. **完整的保留来源选项** - 可选择是否保留转发来源信息

---

## 1. 正则表达式过滤 / Regex Filtering

### 功能说明
除了原有的关键词过滤，现在支持使用正则表达式进行更精确的过滤。

### 使用场景
- 匹配特定格式的内容（如 URL、邮箱、电话号码）
- 复杂的文本模式匹配
- 更灵活的过滤条件

### 示例
**白名单正则表达式：**
- `https?://[^\s]+` - 匹配包含 URL 的消息
- `\d{6,}` - 匹配包含 6 位以上数字的消息
- `\b[A-Z]{2,}\b` - 匹配包含全大写单词的消息

**黑名单正则表达式：**
- `广告|推广|垃圾` - 匹配包含这些词的消息（用 | 表示"或"）
- `\d{11}` - 匹配包含 11 位数字（如手机号）的消息

### 配置方式
1. 添加监控任务时，在"步骤3：过滤规则"中选择"🟢 正则白名单"或"🔴 正则黑名单"
2. 输入正则表达式，多个表达式用逗号分隔
3. 系统会验证正则表达式的有效性

---

## 2. 提取模式 / Extract Mode

### 功能说明
提取模式允许你从匹配的消息中提取特定内容，只转发提取的内容，而不是整条消息。

### 使用场景
- 从消息中提取 URL 链接
- 提取代码或密钥
- 提取数字信息（如价格、编号）
- 从长消息中提取关键信息

### 工作流程
1. 消息首先通过过滤规则（关键词/正则）
2. 如果通过过滤，使用提取规则从消息中提取内容
3. 将提取的内容合并后发送到目标

### 示例

**场景：提取分享的链接**
- 过滤规则：正则白名单 `分享|推荐`
- 提取规则：`https?://[^\s]+`
- 效果：只转发消息中的 URL 链接

**场景：提取验证码**
- 过滤规则：关键词白名单 `验证码,code`
- 提取规则：`\d{4,6}`
- 效果：只转发数字验证码

**场景：提取多种信息**
- 提取规则：`https?://[^\s]+,\d{6,}`
- 效果：同时提取 URL 和 6 位以上数字

### 配置方式
1. 添加监控任务时，在"选择转发模式"步骤选择"🎯 提取模式"
2. 输入提取用的正则表达式，多个表达式用逗号分隔
3. 提取的所有匹配内容会去重后发送

---

## 3. 监控任务编辑 / Edit Monitor Tasks

### 功能说明
可以随时查看和修改已创建的监控任务配置。

### 可编辑项
- ✏️ **过滤规则** - 修改关键词白名单/黑名单、正则白名单/黑名单、提取规则
- 🔄 **转发模式** - 在完整转发和提取模式之间切换
- 📤 **保留来源** - 开启或关闭转发来源显示
- 🗑 **删除监控** - 删除不需要的监控任务

### 使用方式
1. 发送 `/watch` 或点击"监控管理"
2. 点击"📋 查看列表"
3. 点击要编辑的监控任务
4. 选择要修改的项目
5. 按提示输入新的配置

### 清空规则
在编辑过滤规则时，可以点击"🗑 清空"按钮删除该规则的所有内容。

---

## 4. 保留转发来源 / Preserve Forward Source

### 功能说明
选择转发时是否显示"Forwarded from..."信息。

### 选项
- **❌ 否（推荐）** - 使用 copy_message，不显示来源
- **✅ 是** - 使用 forward_messages，显示"Forwarded from..."

### 注意事项
- 提取模式下此选项无效（提取的内容总是以新消息发送）
- 某些频道设置可能禁止转发

---

## 配置文件格式 / Config File Format

```json
{
  "user_id": {
    "source_chat_id": {
      "dest": "dest_chat_id",
      "whitelist": ["keyword1", "keyword2"],
      "blacklist": ["keyword3"],
      "whitelist_regex": ["regex_pattern1"],
      "blacklist_regex": ["regex_pattern2"],
      "preserve_forward_source": false,
      "forward_mode": "full",
      "extract_patterns": ["extract_pattern1"]
    }
  }
}
```

### 字段说明
- `whitelist` - 关键词白名单（数组）
- `blacklist` - 关键词黑名单（数组）
- `whitelist_regex` - 正则表达式白名单（数组）
- `blacklist_regex` - 正则表达式黑名单（数组）
- `preserve_forward_source` - 是否保留转发来源（布尔值）
- `forward_mode` - 转发模式："full" 或 "extract"
- `extract_patterns` - 提取模式的正则表达式（数组）

---

## 过滤规则优先级 / Filter Priority

消息按以下顺序检查，所有检查都通过才会转发/提取：

1. **关键词白名单** - 如果设置，消息必须包含至少一个关键词
2. **关键词黑名单** - 如果消息包含任一黑名单关键词，跳过
3. **正则白名单** - 如果设置，消息必须匹配至少一个正则
4. **正则黑名单** - 如果消息匹配任一黑名单正则，跳过

**提示：** 白名单和黑名单可以同时使用，例如：
- 白名单：`重要` - 只处理包含"重要"的消息
- 黑名单：`测试` - 但跳过包含"测试"的消息
- 结果：只转发包含"重要"但不包含"测试"的消息

---

## 正则表达式示例 / Regex Examples

### 常用模式

**URLs:**
```
https?://[^\s]+
```

**邮箱:**
```
[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}
```

**电话号码（中国）:**
```
1[3-9]\d{9}
```

**数字验证码:**
```
\d{4,6}
```

**比特币地址:**
```
[13][a-km-zA-HJ-NP-Z1-9]{25,34}
```

**IP 地址:**
```
\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}
```

### 高级技巧

**捕获组:**
```
https?://([^\s/]+)
```
提取域名部分

**忽略大小写:**
```
(?i)important|urgent
```
不区分大小写地匹配

**非贪婪匹配:**
```
价格：(\d+?)元
```
提取价格数字

---

## 注意事项 / Notes

1. **正则表达式验证** - 系统会在保存前验证正则表达式的有效性
2. **性能** - 复杂的正则表达式可能影响处理速度
3. **向后兼容** - 旧的配置文件会自动兼容，缺失的字段使用默认值
4. **提取模式限制** - 仅提取文本内容，不会转发媒体文件
5. **去重** - 提取模式会自动去重相同的提取结果

---

## 示例场景 / Example Scenarios

### 场景 1：监控技术博客，只提取链接
```
来源：@TechBlog
目标：me（个人收藏）
过滤：关键词白名单 - "推荐,分享"
模式：提取模式
提取规则：https?://[^\s]+
```

### 场景 2：监控交易群，提取价格信息
```
来源：Trading Group
目标：@MyChannel
过滤：正则白名单 - "价格|报价"
模式：提取模式
提取规则：\d+\.?\d*
```

### 场景 3：转发重要通知，排除测试消息
```
来源：@Official
目标：me
过滤：
  - 关键词白名单：重要,紧急,通知
  - 关键词黑名单：测试
模式：完整转发
保留来源：是
```

---

## 技术支持 / Support

如有问题或建议，请访问：
- GitHub: https://github.com/bipinkrish/Save-Restricted-Bot
- Issues: https://github.com/bipinkrish/Save-Restricted-Bot/issues
