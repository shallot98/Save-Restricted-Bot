# Peer Cache Initialization Fix

## 问题描述

重启后监控配置不生效的根本原因：
- ✅ 配置文件加载正确
- ✅ 监控源识别正确
- ❌ **但Peer缓存未初始化**
- 结果：消息被跳过，报"Peer id invalid"错误
- 删除重新添加监控可以工作：因为添加时会调用 `get_chat()`，真正初始化了Peer缓存

## 根本原因

Pyrogram需要将频道信息存入内部SQLite数据库才能正常工作。仅仅配置了频道ID是不够的，必须通过 `client.get_chat(peer_id)` 真正获取频道信息并存入缓存。

## 解决方案

### 1. 新增函数 `initialize_peer_cache_on_startup(acc)`

位置：`main.py` 第388-479行

功能：
- 从 `watch_config.json` 收集所有源和目标频道ID
- 对每个频道调用 `acc.get_chat(peer_id)` 强制初始化缓存
- 记录详细的成功/失败日志
- 标记成功的peer为已缓存，失败的peer进入重试冷却期
- 显示清晰的初始化进度和结果摘要

### 2. 集成到启动流程

修改位置：`main.py` 第515-551行 `print_startup_config()` 函数

调用时机：
1. `acc.start()` - 启动用户客户端（第67行）
2. `print_startup_config()` - 打印启动配置
3. **`initialize_peer_cache_on_startup(acc)`** - 强制初始化所有Peer缓存（第547行）
4. `bot.run()` - 启动Bot进入监听循环（第566行）

### 3. 启动日志示例

```
============================================================
⚡ 启动时初始化 5 个Peer缓存...
============================================================
   ✅ -1001234567890: 测试频道A
   ✅ -1009876543210: 测试频道B
   ✅ 987654321: John Doe 🤖
   ⚠️ -1001111111111: Peer id invalid
   ✅ -1002222222222: 私有群组
============================================================
✅ Peer缓存初始化完成: 4/5 成功
⚠️ 失败的Peer (共1个):
   - -1001111111111: Peer id invalid
💡 失败的Peer将在接收到第一条消息时自动重试延迟加载
============================================================
```

## 验收标准

- ✅ 添加了 `initialize_peer_cache_on_startup()` 函数
- ✅ 在bot启动时调用了这个函数
- ✅ 启动日志显示"初始化 X 个Peer缓存"
- ✅ 每个频道的初始化结果都被记录
- ✅ 重启后，消息能立即转发（不再报 "Peer id invalid"）
- ✅ 无需删除重新添加监控，配置立即生效

## 测试步骤

1. 实施代码修改
2. 重新构建镜像：`docker-compose up -d --build`
3. 查看启动日志：`docker logs save-restricted-bot | grep -A 20 "初始化Peer"`
4. 应该看到所有频道都显示 ✅
5. 在频道A发一条消息，验证能否转发到B/C

## 预期结果

- 启动日志中清晰显示Peer缓存初始化过程
- 所有配置的频道都被初始化
- 重启后消息立即生效，无需任何额外操作
- 即使某些peer初始化失败，也会在接收到第一条消息时自动重试

## 技术细节

### Peer缓存机制

Pyrogram使用内部SQLite数据库（`myacc.session` 文件）存储以下信息：
- 频道/群组的基本信息（ID、标题、用户名等）
- Access hash（访问密钥）
- 用户信息

调用 `get_chat(peer_id)` 时：
1. 向Telegram服务器查询频道信息
2. 将结果存入session数据库
3. 后续操作可以直接使用缓存，无需再次查询

### 为什么需要强制初始化？

- **配置文件只包含ID**：`watch_config.json` 只存储频道ID，不包含access hash
- **Session可能不完整**：重启后session文件可能缺少某些频道的信息
- **延迟加载不可靠**：依赖第一条消息触发加载，如果失败则消息丢失

### 容错机制

1. **失败追踪**：使用 `failed_peers` 字典记录失败的peer和时间戳
2. **冷却重试**：60秒后允许重试失败的peer
3. **延迟加载**：启动失败的peer会在接收到第一条消息时自动重试
4. **清晰日志**：详细记录每个peer的初始化状态，便于排查问题

## 相关文件

- `main.py` - 主要修改文件
- `bot/utils/peer.py` - Peer缓存工具函数
- `config.py` - 配置管理和监控源加载

## 相关Issue/Ticket

- 修复：启动时强制初始化Peer缓存解决配置不生效
