#!/usr/bin/env python3
"""
æµ‹è¯•å¤šè·³è½¬å‘+æå–é“¾

åœºæ™¯ï¼šAâ†’Cè½¬å‘ï¼ˆç™½åå•"1"ï¼‰+ Câ†’Dæå–ï¼ˆæ­£åˆ™"1"ï¼‰
éªŒè¯ï¼šå½“æ¶ˆæ¯ä»Aè½¬å‘åˆ°Cåï¼ŒCâ†’Dçš„æå–ä»»åŠ¡èƒ½å¦æ­£ç¡®è§¦å‘
"""

import json
import os
import sys

# ç¡®ä¿å¯¼å…¥è·¯å¾„æ­£ç¡®
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def test_config_setup():
    """æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®è®¾ç½®äº†å¤šè·³é“¾"""
    
    # æ¨¡æ‹Ÿé…ç½®
    test_config = {
        "user123": {
            "task1": {
                "source": "A",  # é¢‘é“A
                "dest": "C",    # è½¬å‘åˆ°é¢‘é“C
                "whitelist": ["1"],  # ç™½åå•åŒ…å«"1"
                "forward_mode": "full",
                "record_mode": False
            },
            "task2": {
                "source": "C",  # é¢‘é“C
                "dest": "D",    # æå–åˆ°æœºå™¨äººD
                "extract_patterns": ["1"],  # æ­£åˆ™æå–"1"
                "forward_mode": "extract",
                "record_mode": False
            }
        }
    }
    
    print("âœ… æµ‹è¯•é…ç½®:")
    print(json.dumps(test_config, indent=2, ensure_ascii=False))
    
    # éªŒè¯é…ç½®é€»è¾‘
    # 1. æ¶ˆæ¯"1"åˆ°è¾¾A
    # 2. åŒ¹é…task1çš„whitelist["1"]
    # 3. è½¬å‘åˆ°C
    # 4. åœ¨process_messageä¸­ï¼Œè½¬å‘åæ£€æŸ¥Cæ˜¯å¦æœ‰é…ç½®
    # 5. æ‰¾åˆ°task2: source=C, forward_mode=extract
    # 6. æå–"1"å¹¶å‘é€åˆ°D
    
    print("\nğŸ“‹ é¢„æœŸæµç¨‹:")
    print("1. ç”¨æˆ·å‘é€æ¶ˆæ¯'1'åˆ°é¢‘é“A")
    print("2. task1åŒ¹é…ï¼ˆwhitelist=['1']ï¼‰ï¼Œè½¬å‘Aâ†’C")
    print("3. è½¬å‘åï¼Œæ£€æŸ¥Cæ˜¯å¦æœ‰é…ç½®ä»»åŠ¡")
    print("4. æ‰¾åˆ°task2ï¼ˆsource='C', forward_mode='extract'ï¼‰")
    print("5. åº”ç”¨æå–æ¨¡å¼ï¼ˆextract_patterns=['1']ï¼‰")
    print("6. æå–åˆ°'1'ï¼Œå‘é€åˆ°æœºå™¨äººD")
    print("7. âœ… æˆåŠŸï¼")
    
    return True

def test_filter_logic():
    """æµ‹è¯•è¿‡æ»¤é€»è¾‘"""
    
    # æ¨¡æ‹Ÿæ¶ˆæ¯
    message_text = "1"
    
    # task1çš„è¿‡æ»¤ï¼ˆAâ†’Cï¼‰
    task1_whitelist = ["1"]
    matched = any(kw.lower() in message_text.lower() for kw in task1_whitelist)
    print(f"\nâœ… task1 (Aâ†’C) whitelist check: matched={matched}")
    assert matched, "task1åº”è¯¥åŒ¹é…æ¶ˆæ¯'1'"
    
    # task2çš„æå–ï¼ˆCâ†’Dï¼‰
    import re
    task2_extract_patterns = ["1"]
    extracted_content = []
    for pattern in task2_extract_patterns:
        matches = re.findall(pattern, message_text)
        if matches:
            extracted_content.extend(matches)
    
    print(f"âœ… task2 (Câ†’D) extract: extracted={extracted_content}")
    assert extracted_content == ["1"], "task2åº”è¯¥æå–åˆ°'1'"
    
    return True

def test_nested_check_logic():
    """æµ‹è¯•åµŒå¥—æ£€æŸ¥é€»è¾‘"""
    
    # æ¨¡æ‹Ÿè½¬å‘åçš„æ£€æŸ¥
    dest_chat_id = "C"
    
    # æ¨¡æ‹Ÿwatch_config
    watch_config = {
        "user123": {
            "task2": {
                "source": "C",
                "dest": "D",
                "extract_patterns": ["1"],
                "forward_mode": "extract",
                "record_mode": False
            }
        }
    }
    
    # æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„ä»»åŠ¡
    found_task = False
    for user_id, watches in watch_config.items():
        for watch_key, watch_data in watches.items():
            if isinstance(watch_data, dict):
                check_source = str(watch_data.get("source", ""))
                check_record_mode = watch_data.get("record_mode", False)
                check_dest = watch_data.get("dest")
                
                # æ£€æŸ¥æ˜¯å¦åŒ¹é…è½¬å‘æ¨¡å¼
                if check_source == dest_chat_id and not check_record_mode and check_dest:
                    print(f"\nâœ… æ‰¾åˆ°ç›®æ ‡é¢‘é“è½¬å‘ä»»åŠ¡:")
                    print(f"   user_id: {user_id}")
                    print(f"   task: {watch_key}")
                    print(f"   source: {check_source}")
                    print(f"   dest: {check_dest}")
                    print(f"   forward_mode: {watch_data.get('forward_mode')}")
                    found_task = True
    
    assert found_task, "åº”è¯¥æ‰¾åˆ°Câ†’Dçš„è½¬å‘ä»»åŠ¡"
    return True

if __name__ == "__main__":
    print("="*60)
    print("ğŸ§ª æµ‹è¯•å¤šè·³è½¬å‘+æå–é“¾")
    print("="*60)
    
    try:
        test_config_setup()
        test_filter_logic()
        test_nested_check_logic()
        
        print("\n" + "="*60)
        print("âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
        print("="*60)
        
        print("\nğŸ“ ä¿®å¤è¯´æ˜:")
        print("- åœ¨process_messageä¸­ï¼Œè½¬å‘åä¼šæ£€æŸ¥ç›®æ ‡é¢‘é“æ˜¯å¦é…ç½®äº†ä»»åŠ¡")
        print("- æ”¯æŒrecord_modeï¼ˆè®°å½•æ¨¡å¼ï¼‰å’Œforward_modeï¼ˆè½¬å‘/æå–æ¨¡å¼ï¼‰")
        print("- å¯¹äºextractæ¨¡å¼ï¼Œä¼šåº”ç”¨æå–æ¨¡å¼å¹¶å‘é€æå–å†…å®¹")
        print("- è§£å†³äº†Aâ†’Câ†’Då¤šè·³é“¾ä¸­ï¼ŒCâ†’Dæå–å¤±è´¥çš„é—®é¢˜")
        
    except AssertionError as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
