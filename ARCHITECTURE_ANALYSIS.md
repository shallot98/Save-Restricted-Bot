# ğŸ—ï¸ Save-Restricted-Bot æ¶æ„åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-12-13
**é¡¹ç›®ç‰ˆæœ¬**: 2.0.0
**ä»£ç è§„æ¨¡**: ~18,500è¡ŒPythonä»£ç 

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆ](#é¡¹ç›®æ¦‚è§ˆ)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
5. [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)
6. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
7. [æ¶æ„ä¼˜ç¼ºç‚¹](#æ¶æ„ä¼˜ç¼ºç‚¹)
8. [æ”¹è¿›å»ºè®®](#æ”¹è¿›å»ºè®®)

---

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ

### é¡¹ç›®å®šä½

**Save-Restricted-Bot** æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„Telegramæœºå™¨äººï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- ğŸ“¥ **æ¶ˆæ¯è½¬å‘** - è½¬å‘å—é™å†…å®¹
- ğŸ‘ **é¢‘é“ç›‘æ§** - è‡ªåŠ¨ç›‘æ§å¹¶è½¬å‘æ–°æ¶ˆæ¯
- ğŸ“ **ç¬”è®°è®°å½•** - ä¿å­˜æ¶ˆæ¯åˆ°Webç•Œé¢
- ğŸ” **æ™ºèƒ½è¿‡æ»¤** - å…³é”®è¯å’Œæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
- ğŸ¯ **å†…å®¹æå–** - æå–ç‰¹å®šå†…å®¹
- ğŸ”— **ç£åŠ›é“¾æ¥ç®¡ç†** - è‡ªåŠ¨æ ¡å‡†ç£åŠ›é“¾æ¥æ–‡ä»¶å
- â˜ï¸ **WebDAVé›†æˆ** - è¿œç¨‹å­˜å‚¨æ”¯æŒ

### ä»£ç ç»Ÿè®¡

| å±‚çº§ | ä»£ç è¡Œæ•° | æ–‡ä»¶æ•° | å æ¯” |
|------|---------|--------|------|
| **å¤„ç†å™¨å±‚** (handlers) | 2,426 | 8 | 37.7% |
| **å·¥å…·å±‚** (utils) | 1,000 | 8 | 15.5% |
| **æœåŠ¡å±‚** (services) | 998 | 4 | 15.5% |
| **æ ¸å¿ƒå±‚** (core) | 269 | 3 | 4.2% |
| **Webåº”ç”¨** (app.py) | 892 | 1 | 13.9% |
| **æ•°æ®åº“** (database.py) | 1,029 | 1 | 16.0% |
| **é…ç½®** (config.py) | 248 | 1 | 3.9% |
| **æ€»è®¡** | ~6,862 | 26 | 100% |

---

## ğŸ›ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

é¡¹ç›®é‡‡ç”¨ **åˆ†å±‚æ¶æ„ + äº‹ä»¶é©±åŠ¨** çš„æ··åˆæ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·äº¤äº’å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Telegram Bot â”‚  â”‚  Web Interfaceâ”‚  â”‚  WebDAV API  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤„ç†å™¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Commands   â”‚  â”‚   Callbacks  â”‚  â”‚   Messages   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ Auto Forward â”‚  â”‚  Watch Setup â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Calibration  â”‚  â”‚  Peer Cache  â”‚  â”‚   Scheduler  â”‚      â”‚
â”‚  â”‚   Manager    â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ ¸å¿ƒå±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    Client    â”‚  â”‚  Message     â”‚  â”‚   Startup    â”‚      â”‚
â”‚  â”‚ Initializationâ”‚  â”‚    Queue     â”‚  â”‚    Config    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   SQLite     â”‚  â”‚  File System â”‚  â”‚   WebDAV     â”‚      â”‚
â”‚  â”‚   Database   â”‚  â”‚   (Media)    â”‚  â”‚   Storage    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„æ¨¡å¼

#### 1. **åˆ†å±‚æ¶æ„** (Layered Architecture)

**ä¼˜ç‚¹**:
- âœ… æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- âœ… æ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… æ”¯æŒç‹¬ç«‹æµ‹è¯•

**å±‚çº§è¯´æ˜**:

| å±‚çº§ | èŒè´£ | ä¾èµ–æ–¹å‘ |
|------|------|---------|
| **ç”¨æˆ·äº¤äº’å±‚** | æ¥æ”¶ç”¨æˆ·è¾“å…¥ | â†’ å¤„ç†å™¨å±‚ |
| **å¤„ç†å™¨å±‚** | å¤„ç†ä¸šåŠ¡é€»è¾‘ | â†’ æœåŠ¡å±‚ |
| **æœåŠ¡å±‚** | æä¾›ä¸šåŠ¡æœåŠ¡ | â†’ æ ¸å¿ƒå±‚ |
| **æ ¸å¿ƒå±‚** | åŸºç¡€è®¾æ–½ | â†’ æ•°æ®å±‚ |
| **æ•°æ®å±‚** | æ•°æ®æŒä¹…åŒ– | - |

#### 2. **äº‹ä»¶é©±åŠ¨** (Event-Driven)

**å®ç°æ–¹å¼**:
- Pyrogramè£…é¥°å™¨æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
- æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
- å›è°ƒæŸ¥è¯¢åˆ†å‘æœºåˆ¶

**ç¤ºä¾‹**:
```python
# äº‹ä»¶æ³¨å†Œ
@bot.on_message(filters.text & filters.private)
def handle_message(client, message):
    # å¤„ç†æ¶ˆæ¯äº‹ä»¶
    pass

@bot.on_callback_query()
def handle_callback(client, callback_query):
    # å¤„ç†å›è°ƒäº‹ä»¶
    pass
```

#### 3. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼** (Producer-Consumer)

**åº”ç”¨åœºæ™¯**: æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†

```python
# ç”Ÿäº§è€…ï¼šauto_forward_handler
message_queue.put(Message(...))

# æ¶ˆè´¹è€…ï¼šMessageWorker
while True:
    message = message_queue.get()
    process_message(message)
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Python** | 3.10+ | ä¸»è¦ç¼–ç¨‹è¯­è¨€ |
| **Pyrogram** | Latest | Telegram Botæ¡†æ¶ |
| **Flask** | Latest | Webæ¡†æ¶ |
| **SQLite** | 3.x | æ•°æ®åº“ |
| **bcrypt** | Latest | å¯†ç åŠ å¯† |
| **Pillow** | Latest | å›¾ç‰‡å¤„ç† |
| **libtorrent** | Latest | ç£åŠ›é“¾æ¥å¤„ç† |
| **webdavclient3** | Latest | WebDAVå®¢æˆ·ç«¯ |

### å‰ç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **HTML/CSS/JS** | Webç•Œé¢ |
| **Jinja2** | æ¨¡æ¿å¼•æ“ |
| **å“åº”å¼è®¾è®¡** | ç§»åŠ¨ç«¯é€‚é… |

### æµ‹è¯•æ¡†æ¶

| æ¡†æ¶ | ç”¨é€” |
|------|------|
| **pytest** | å•å…ƒæµ‹è¯• |
| **playwright** | E2Eæµ‹è¯• |

### éƒ¨ç½²å·¥å…·

| å·¥å…· | ç”¨é€” |
|------|------|
| **Docker** | å®¹å™¨åŒ– |
| **docker-compose** | ç¼–æ’ |

---

## ğŸ“¦ æ¨¡å—è¯¦è§£

### 1. æ ¸å¿ƒå±‚ (bot/core/)

**ä»£ç é‡**: 269è¡Œ

#### bot/core/client.py (104è¡Œ)
```python
def initialize_clients():
    """åˆå§‹åŒ–Botå’ŒUserå®¢æˆ·ç«¯"""
    # 1. åŠ è½½é…ç½®
    # 2. åˆ›å»ºBotå®¢æˆ·ç«¯
    # 3. åˆ›å»ºUserå®¢æˆ·ç«¯ï¼ˆå¯é€‰ï¼‰
    # 4. è¿”å›å®¢æˆ·ç«¯å®ä¾‹
```

**èŒè´£**:
- åˆå§‹åŒ–Pyrogramå®¢æˆ·ç«¯
- ç®¡ç†Bot Tokenå’ŒSession String
- å¤„ç†å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸ

#### bot/core/queue.py (64è¡Œ)
```python
def initialize_message_queue(acc):
    """åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ—å’Œå·¥ä½œçº¿ç¨‹"""
    # 1. åˆ›å»ºçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
    # 2. å¯åŠ¨MessageWorkerçº¿ç¨‹
    # 3. è¿”å›é˜Ÿåˆ—å®ä¾‹
```

**èŒè´£**:
- åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
- å¯åŠ¨åå°å·¥ä½œçº¿ç¨‹
- ç®¡ç†é˜Ÿåˆ—ç”Ÿå‘½å‘¨æœŸ

#### bot/core/startup.py (101è¡Œ)
```python
def print_startup_config(acc):
    """æ‰“å°å¯åŠ¨é…ç½®ä¿¡æ¯"""
    # æ˜¾ç¤ºBotä¿¡æ¯ã€é…ç½®çŠ¶æ€ç­‰
```

**èŒè´£**:
- æ‰“å°å¯åŠ¨ä¿¡æ¯
- æ˜¾ç¤ºé…ç½®çŠ¶æ€
- æä¾›è°ƒè¯•ä¿¡æ¯

---

### 2. å¤„ç†å™¨å±‚ (bot/handlers/)

**ä»£ç é‡**: 2,426è¡Œ

#### bot/handlers/commands.py (114è¡Œ)
```python
def register_command_handlers(bot, acc):
    """æ³¨å†Œå‘½ä»¤å¤„ç†å™¨"""
    @bot.on_message(filters.command("start"))
    def start_command(client, message):
        # å¤„ç†/startå‘½ä»¤
```

**æ”¯æŒçš„å‘½ä»¤**:
- `/start` - å¯åŠ¨æœºå™¨äºº
- `/help` - æ˜¾ç¤ºå¸®åŠ©
- `/watch` - ç›‘æ§ç®¡ç†

#### bot/handlers/callbacks.py (927è¡Œ) âš ï¸
```python
def callback_handler(client, callback_query):
    """å¤„ç†æ‰€æœ‰å›è°ƒæŸ¥è¯¢"""
    # è¶…é•¿å‡½æ•°ï¼ˆ906è¡Œï¼‰
    # åŒ…å«æ‰€æœ‰å›è°ƒé€»è¾‘
```

**é—®é¢˜**:
- âŒ å•ä¸ªå‡½æ•°è¿‡é•¿ï¼ˆ906è¡Œï¼‰
- âŒ è¿åå•ä¸€èŒè´£åŸåˆ™
- âœ… å·²åˆ›å»ºé‡æ„æ¶æ„ï¼ˆcallback_registry.pyï¼‰

#### bot/handlers/messages.py (392è¡Œ)
```python
def save(client, message):
    """å¤„ç†ç”¨æˆ·æ–‡æœ¬è¾“å…¥"""
    # 1. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    # 2. å¤„ç†å¤šæ­¥éª¤äº¤äº’
    # 3. å¤„ç†Telegramé“¾æ¥
```

**èŒè´£**:
- å¤„ç†ç§èŠæ¶ˆæ¯
- è§£æTelegramé“¾æ¥
- æ‰¹é‡è½¬å‘æ¶ˆæ¯

#### bot/handlers/auto_forward.py (171è¡Œ)
```python
def create_auto_forward_handler(acc, message_queue):
    """åˆ›å»ºè‡ªåŠ¨è½¬å‘å¤„ç†å™¨"""
    @acc.on_message(filters.all)
    def auto_forward(client, message):
        # ç›‘æ§æ¶ˆæ¯å¹¶åŠ å…¥é˜Ÿåˆ—
```

**èŒè´£**:
- ç›‘æ§é¢‘é“/ç¾¤ç»„æ¶ˆæ¯
- åº”ç”¨è¿‡æ»¤è§„åˆ™
- å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—

#### bot/handlers/watch_setup.py (449è¡Œ)
```python
def show_filter_options(chat_id, message_id, user_id):
    """æ˜¾ç¤ºè¿‡æ»¤é€‰é¡¹"""
    # æ„å»ºè¿‡æ»¤å™¨é…ç½®ç•Œé¢
```

**èŒè´£**:
- ç›‘æ§ä»»åŠ¡è®¾ç½®å‘å¯¼
- è¿‡æ»¤å™¨é…ç½®
- ç›®æ ‡é€‰æ‹©

---

### 3. æœåŠ¡å±‚ (bot/services/)

**ä»£ç é‡**: 998è¡Œ

#### bot/services/calibration_manager.py (429è¡Œ)
```python
class CalibrationManager:
    """æ ¡å‡†ä»»åŠ¡ç®¡ç†å™¨"""

    def add_note_to_calibration_queue(self, note_id):
        """æ·»åŠ ç¬”è®°åˆ°æ ¡å‡†é˜Ÿåˆ—"""

    def process_calibration_task(self, task):
        """å¤„ç†æ ¡å‡†ä»»åŠ¡"""

    def calibrate_magnet(self, magnet_hash):
        """æ ¡å‡†ç£åŠ›é“¾æ¥"""
```

**èŒè´£**:
- ç®¡ç†ç£åŠ›é“¾æ¥æ ¡å‡†ä»»åŠ¡
- è‡ªåŠ¨æ ¡å‡†æ–‡ä»¶å
- é‡è¯•æœºåˆ¶

#### bot/services/peer_cache.py (349è¡Œ)
```python
def initialize_peer_cache_on_startup_with_retry(acc):
    """åˆå§‹åŒ–Peerç¼“å­˜"""
    # é¢„åŠ è½½å¸¸ç”¨èŠå¤©çš„Peerä¿¡æ¯
```

**èŒè´£**:
- ç¼“å­˜Telegram Peerä¿¡æ¯
- å‡å°‘APIè°ƒç”¨
- æå‡æ€§èƒ½

#### bot/services/calibration_scheduler.py (107è¡Œ)
```python
def start_scheduler(interval=60):
    """å¯åŠ¨æ ¡å‡†è°ƒåº¦å™¨"""
    # å®šæœŸæ£€æŸ¥å¾…å¤„ç†çš„æ ¡å‡†ä»»åŠ¡
```

**èŒè´£**:
- å®šæœŸæ‰§è¡Œæ ¡å‡†ä»»åŠ¡
- ç®¡ç†è°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸ

---

### 4. å·¥å…·å±‚ (bot/utils/)

**ä»£ç é‡**: 1,000è¡Œ

#### bot/utils/magnet_utils.py (287è¡Œ) âœ¨
```python
class MagnetLinkParser:
    """ç£åŠ›é“¾æ¥è§£æå™¨"""

    @staticmethod
    def extract_all_magnets(text):
        """æå–æ‰€æœ‰ç£åŠ›é“¾æ¥"""

    @staticmethod
    def extract_info_hash(magnet):
        """æå–info hash"""

    @staticmethod
    def build_magnet_link(info_hash, filename):
        """æ„å»ºç£åŠ›é“¾æ¥"""
```

**èŒè´£**:
- ç»Ÿä¸€ç£åŠ›é“¾æ¥å¤„ç†
- æ¶ˆé™¤ä»£ç é‡å¤
- æä¾›å·¥å…·å‡½æ•°

#### bot/utils/dedup.py (186è¡Œ)
```python
def is_media_group_processed(media_group_id):
    """æ£€æŸ¥åª’ä½“ç»„æ˜¯å¦å·²å¤„ç†"""

def register_processed_media_group(media_group_id):
    """æ³¨å†Œå·²å¤„ç†çš„åª’ä½“ç»„"""
```

**èŒè´£**:
- æ¶ˆæ¯å»é‡
- åª’ä½“ç»„å»é‡
- å†…å­˜ç®¡ç†

#### bot/utils/logger.py (70è¡Œ)
```python
def setup_logging():
    """è®¾ç½®æ—¥å¿—ç³»ç»Ÿ"""
    # é…ç½®æ–‡ä»¶æ—¥å¿—å’Œæ§åˆ¶å°æ—¥å¿—
```

**èŒè´£**:
- æ—¥å¿—é…ç½®
- æ—¥å¿—è½®è½¬
- å½©è‰²è¾“å‡º

#### bot/utils/progress.py (168è¡Œ)
```python
def progress(current, total, message, status):
    """æ˜¾ç¤ºè¿›åº¦"""
    # æ›´æ–°ä¸‹è½½/ä¸Šä¼ è¿›åº¦
```

**èŒè´£**:
- è¿›åº¦æ˜¾ç¤º
- çŠ¶æ€æ›´æ–°

---

### 5. å·¥ä½œçº¿ç¨‹å±‚ (bot/workers/)

**ä»£ç é‡**: 1,036è¡Œ

#### bot/workers/message_worker.py (1,036è¡Œ)
```python
class MessageWorker:
    """æ¶ˆæ¯é˜Ÿåˆ—å·¥ä½œçº¿ç¨‹"""

    def run(self):
        """ä¸»å¾ªç¯"""
        while self.running:
            message = self.queue.get()
            self.process_message(message)

    def process_message(self, message):
        """å¤„ç†å•æ¡æ¶ˆæ¯"""
        # 1. åº”ç”¨è¿‡æ»¤å™¨
        # 2. ä¸‹è½½åª’ä½“
        # 3. è½¬å‘æˆ–è®°å½•
        # 4. é‡è¯•æœºåˆ¶
```

**èŒè´£**:
- å¼‚æ­¥å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
- åº”ç”¨è¿‡æ»¤è§„åˆ™
- ä¸‹è½½å’Œè½¬å‘åª’ä½“
- é”™è¯¯é‡è¯•

---

### 6. æ•°æ®å±‚

#### database.py (1,029è¡Œ)
```python
# è¡¨ç»“æ„
CREATE TABLE notes (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    source_chat_id TEXT,
    message_text TEXT,
    media_paths TEXT,
    magnet_link TEXT,
    filename TEXT,
    is_favorite INTEGER
)

CREATE TABLE calibration_tasks (
    id INTEGER PRIMARY KEY,
    note_id INTEGER,
    status TEXT,
    retry_count INTEGER,
    next_attempt DATETIME
)
```

**ä¸»è¦å‡½æ•°**:
- `add_note()` - æ·»åŠ ç¬”è®°
- `get_notes()` - æŸ¥è¯¢ç¬”è®°
- `update_note_with_calibrated_dns()` - æ›´æ–°æ ¡å‡†ç»“æœ
- `add_calibration_task()` - æ·»åŠ æ ¡å‡†ä»»åŠ¡

#### config.py (248è¡Œ)
```python
def load_config():
    """åŠ è½½ä¸»é…ç½®"""

def load_watch_config():
    """åŠ è½½ç›‘æ§é…ç½®"""

def reload_monitored_sources():
    """é‡æ–°åŠ è½½ç›‘æ§æº"""
```

**é…ç½®æ–‡ä»¶**:
- `config.json` - ä¸»é…ç½®ï¼ˆTokenã€API IDç­‰ï¼‰
- `watch_config.json` - ç›‘æ§é…ç½®
- `webdav_config.json` - WebDAVé…ç½®
- `viewer_config.json` - è§‚çœ‹ç½‘ç«™é…ç½®

---

### 7. Webåº”ç”¨å±‚

#### app.py (892è¡Œ)
```python
app = Flask(__name__)

@app.route('/notes')
def notes():
    """ç¬”è®°åˆ—è¡¨é¡µé¢"""

@app.route('/api/calibrate/<int:note_id>', methods=['POST'])
def api_calibrate(note_id):
    """æ ¡å‡†API"""
```

**è·¯ç”±**:
- `/` - é¦–é¡µï¼ˆé‡å®šå‘åˆ°ç¬”è®°ï¼‰
- `/login` - ç™»å½•
- `/notes` - ç¬”è®°åˆ—è¡¨
- `/admin` - ç®¡ç†é¢æ¿
- `/api/*` - REST API

---

## ğŸ”„ æ•°æ®æµåˆ†æ

### 1. æ¶ˆæ¯è½¬å‘æµç¨‹

```
ç”¨æˆ·å‘é€é“¾æ¥
    â†“
messages.save()
    â†“
è§£æTelegramé“¾æ¥
    â†“
handle_private() ä¸‹è½½åª’ä½“
    â†“
è½¬å‘åˆ°ç”¨æˆ·
```

### 2. è‡ªåŠ¨ç›‘æ§æµç¨‹

```
ç›‘æ§æºæ”¶åˆ°æ–°æ¶ˆæ¯
    â†“
auto_forward_handler
    â†“
åº”ç”¨è¿‡æ»¤è§„åˆ™
    â†“
åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—
    â†“
MessageWorkerå¤„ç†
    â†“
è½¬å‘æˆ–è®°å½•åˆ°æ•°æ®åº“
```

### 3. ç£åŠ›é“¾æ¥æ ¡å‡†æµç¨‹

```
ä¿å­˜ç¬”è®°ï¼ˆåŒ…å«ç£åŠ›é“¾æ¥ï¼‰
    â†“
add_note() æå–ç£åŠ›é“¾æ¥
    â†“
add_calibration_task() åˆ›å»ºæ ¡å‡†ä»»åŠ¡
    â†“
è°ƒåº¦å™¨å®šæœŸæ£€æŸ¥
    â†“
CalibrationManager.process_task()
    â†“
è°ƒç”¨æ ¡å‡†è„šæœ¬è·å–æ–‡ä»¶å
    â†“
update_note_with_calibrated_dns()
```

### 4. Webç¬”è®°æŸ¥çœ‹æµç¨‹

```
ç”¨æˆ·è®¿é—® /notes
    â†“
get_notes() æŸ¥è¯¢æ•°æ®åº“
    â†“
extract_all_dns_from_note() æå–ç£åŠ›ä¿¡æ¯
    â†“
æ¸²æŸ“æ¨¡æ¿
    â†“
è¿”å›HTMLé¡µé¢
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### Dockeréƒ¨ç½²

```yaml
# docker-compose.yml
services:
  bot:
    build: .
    ports:
      - "5000:5000"  # Webç•Œé¢
      - "10000:10000"  # å¥åº·æ£€æŸ¥
    volumes:
      - ./data:/app/data  # æ•°æ®æŒä¹…åŒ–
      - ./config.json:/app/config.json
    environment:
      - TOKEN=${TOKEN}
      - ID=${ID}
      - HASH=${HASH}
      - STRING=${STRING}
```

### ç›®å½•ç»“æ„

```
/root/Save-Restricted-Bot/
â”œâ”€â”€ bot/                    # Botæ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒå±‚ (269è¡Œ)
â”‚   â”œâ”€â”€ handlers/          # å¤„ç†å™¨å±‚ (2,426è¡Œ)
â”‚   â”œâ”€â”€ services/          # æœåŠ¡å±‚ (998è¡Œ)
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å±‚ (1,000è¡Œ)
â”‚   â”œâ”€â”€ workers/           # å·¥ä½œçº¿ç¨‹ (1,036è¡Œ)
â”‚   â”œâ”€â”€ filters/           # è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ storage/           # å­˜å‚¨ç®¡ç†
â”‚   â””â”€â”€ config/            # é…ç½®æ¨¡å—
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â”œâ”€â”€ notes.db           # SQLiteæ•°æ®åº“
â”‚   â”œâ”€â”€ media/             # åª’ä½“æ–‡ä»¶
â”‚   â”œâ”€â”€ logs/              # æ—¥å¿—æ–‡ä»¶
â”‚   â””â”€â”€ config/            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/
â”‚   â””â”€â”€ js/
â”œâ”€â”€ templates/              # HTMLæ¨¡æ¿
â”œâ”€â”€ tests/                  # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯• (57ä¸ª)
â”‚   â”œâ”€â”€ integration/       # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ mobile/            # ç§»åŠ¨ç«¯æµ‹è¯•
â”œâ”€â”€ main.py                 # Botå…¥å£
â”œâ”€â”€ app.py                  # Webå…¥å£ (892è¡Œ)
â”œâ”€â”€ database.py             # æ•°æ®åº“ (1,029è¡Œ)
â”œâ”€â”€ config.py               # é…ç½® (248è¡Œ)
â””â”€â”€ requirements.txt        # ä¾èµ–
```

---

## âš–ï¸ æ¶æ„ä¼˜ç¼ºç‚¹

### âœ… ä¼˜ç‚¹

1. **æ¸…æ™°çš„åˆ†å±‚æ¶æ„**
   - èŒè´£åˆ†ç¦»æ˜ç¡®
   - æ˜“äºç†è§£å’Œç»´æŠ¤
   - æ”¯æŒç‹¬ç«‹æµ‹è¯•

2. **æ¨¡å—åŒ–è®¾è®¡**
   - åŠŸèƒ½æ¨¡å—ç‹¬ç«‹
   - ä½è€¦åˆé«˜å†…èš
   - æ˜“äºæ‰©å±•

3. **å¼‚æ­¥å¤„ç†**
   - æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦
   - åå°ä»»åŠ¡å¤„ç†
   - æå‡å“åº”é€Ÿåº¦

4. **æ•°æ®ç‹¬ç«‹æ€§**
   - ç‹¬ç«‹çš„dataç›®å½•
   - é˜²æ­¢æ›´æ–°æ—¶æ•°æ®ä¸¢å¤±
   - æ˜“äºå¤‡ä»½å’Œè¿ç§»

5. **é…ç½®å¤–éƒ¨åŒ–**
   - ç¯å¢ƒå˜é‡æ”¯æŒ
   - é…ç½®æ–‡ä»¶åˆ†ç¦»
   - æ˜“äºéƒ¨ç½²

6. **å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ**
   - æ–‡ä»¶æ—¥å¿—è½®è½¬
   - å½©è‰²æ§åˆ¶å°è¾“å‡º
   - è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

7. **æµ‹è¯•è¦†ç›–**
   - 57ä¸ªå•å…ƒæµ‹è¯•
   - 75%æµ‹è¯•è¦†ç›–ç‡
   - æŒç»­é›†æˆæ”¯æŒ

### âŒ ç¼ºç‚¹

1. **è¶…é•¿å‡½æ•°**
   - `callbacks.py:callback_handler` (906è¡Œ)
   - è¿åKISSåŸåˆ™
   - éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•

2. **å…¨å±€çŠ¶æ€**
   - ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨å®ä¾‹
   - é™ä½å¯æµ‹è¯•æ€§
   - æ½œåœ¨çš„çº¿ç¨‹å®‰å…¨é—®é¢˜

3. **ç´§è€¦åˆ**
   - éƒ¨åˆ†æ¨¡å—ç›´æ¥ä¾èµ–å…·ä½“å®ç°
   - ç¼ºå°‘æŠ½è±¡æ¥å£å±‚
   - éš¾ä»¥æ›¿æ¢å®ç°

4. **ç¼ºå°‘ä¾èµ–æ³¨å…¥**
   - ç¡¬ç¼–ç ä¾èµ–å…³ç³»
   - é™ä½çµæ´»æ€§
   - å¢åŠ æµ‹è¯•éš¾åº¦

5. **æ–‡æ¡£ä¸å®Œæ•´**
   - éƒ¨åˆ†å‡½æ•°ç¼ºå°‘æ–‡æ¡£
   - APIæ–‡æ¡£ç¼ºå¤±
   - æ¶æ„æ–‡æ¡£ä¸è¶³

---

## ğŸ¯ æ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **é‡æ„è¶…é•¿å‡½æ•°**
   ```python
   # å½“å‰: callbacks.py (906è¡Œ)
   # ç›®æ ‡: æ‹†åˆ†ä¸ºå¤šä¸ª<50è¡Œçš„å‡½æ•°

   # ä½¿ç”¨å·²åˆ›å»ºçš„å›è°ƒæ³¨å†Œè¡¨
   from bot.handlers.callback_registry import callback_registry

   @callback_registry.register_exact("menu_main")
   def handle_menu_main(callback_query):
       # <50è¡Œå¤„ç†é€»è¾‘
   ```

2. **å¼•å…¥ä¾èµ–æ³¨å…¥**
   ```python
   # å½“å‰: å…¨å±€å˜é‡
   _bot_instance = None

   # æ”¹è¿›: ä¾èµ–æ³¨å…¥
   class BotContext:
       def __init__(self, bot, acc, config):
           self.bot = bot
           self.acc = acc
           self.config = config

   def handle_message(context: BotContext, message):
       # ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–
   ```

3. **æ·»åŠ æŠ½è±¡æ¥å£å±‚**
   ```python
   # å®šä¹‰æ¥å£
   class StorageInterface(ABC):
       @abstractmethod
       def save_file(self, file_path: str) -> str:
           pass

   # å®ç°
   class LocalStorage(StorageInterface):
       def save_file(self, file_path: str) -> str:
           # æœ¬åœ°å­˜å‚¨å®ç°

   class WebDAVStorage(StorageInterface):
       def save_file(self, file_path: str) -> str:
           # WebDAVå­˜å‚¨å®ç°
   ```

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - å®ç°ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥

5. **å®Œå–„æ–‡æ¡£**
   - APIæ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰
   - æ¶æ„æ–‡æ¡£
   - éƒ¨ç½²æ–‡æ¡£

6. **ç›‘æ§å’Œå‘Šè­¦**
   - æ·»åŠ æ€§èƒ½ç›‘æ§
   - é”™è¯¯å‘Šè­¦
   - å¥åº·æ£€æŸ¥

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

7. **å¾®æœåŠ¡åŒ–**
   - æ‹†åˆ†Botå’ŒWebåº”ç”¨
   - ç‹¬ç«‹çš„æ ¡å‡†æœåŠ¡
   - APIç½‘å…³

8. **æ¶ˆæ¯é˜Ÿåˆ—å‡çº§**
   - ä½¿ç”¨Redis/RabbitMQ
   - æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
   - æå‡å¯é æ€§

---

## ğŸ“Š æ¶æ„è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ¨¡å—åŒ–** | 8/10 | æ¸…æ™°çš„åˆ†å±‚ï¼Œä½†å­˜åœ¨è¶…é•¿å‡½æ•° |
| **å¯æ‰©å±•æ€§** | 7/10 | åŸºæœ¬æ”¯æŒæ‰©å±•ï¼Œä½†ç¼ºå°‘æŠ½è±¡å±‚ |
| **å¯ç»´æŠ¤æ€§** | 8/10 | ä»£ç ç»„ç»‡è‰¯å¥½ï¼Œæ–‡æ¡£å¾…å®Œå–„ |
| **å¯æµ‹è¯•æ€§** | 8/10 | 75%æµ‹è¯•è¦†ç›–ç‡ï¼Œéƒ¨åˆ†æ¨¡å—éš¾æµ‹è¯• |
| **æ€§èƒ½** | 7/10 | å¼‚æ­¥å¤„ç†è‰¯å¥½ï¼Œä½†æœ‰ä¼˜åŒ–ç©ºé—´ |
| **å®‰å…¨æ€§** | 8/10 | å¯†ç åŠ å¯†ï¼ŒSQLæ³¨å…¥å·²ä¿®å¤ |
| **å¯é æ€§** | 8/10 | é”™è¯¯å¤„ç†å®Œå–„ï¼Œé‡è¯•æœºåˆ¶å¥å…¨ |
| **æ–‡æ¡£** | 6/10 | ä»£ç æ³¨é‡Šè‰¯å¥½ï¼Œç¼ºå°‘æ¶æ„æ–‡æ¡£ |

**ç»¼åˆè¯„åˆ†**: **7.5/10** (è‰¯å¥½)

---

## ğŸ‰ æ€»ç»“

**Save-Restricted-Bot** é‡‡ç”¨äº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„å’Œäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œä»£ç ç»„ç»‡è‰¯å¥½ï¼ŒåŠŸèƒ½å®Œå–„ã€‚

**ä¸»è¦ä¼˜åŠ¿**:
- âœ… æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- âœ… å®Œå–„çš„æµ‹è¯•è¦†ç›–
- âœ… è‰¯å¥½çš„é”™è¯¯å¤„ç†
- âœ… ç‹¬ç«‹çš„æ•°æ®ç®¡ç†

**æ”¹è¿›ç©ºé—´**:
- âš ï¸ é‡æ„è¶…é•¿å‡½æ•°
- âš ï¸ å¼•å…¥ä¾èµ–æ³¨å…¥
- âš ï¸ æ·»åŠ æŠ½è±¡æ¥å£å±‚
- âš ï¸ å®Œå–„æ–‡æ¡£

**æ¶æ„æˆç†Ÿåº¦**: **ä¸­é«˜çº§** - é€‚åˆä¸­å°å‹é¡¹ç›®ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-12-13
**åˆ†æäººå‘˜**: Claude Code AI Assistant
**å»ºè®®**: ç»§ç»­æŒ‰ç…§æ”¹è¿›å»ºè®®ä¼˜åŒ–æ¶æ„ï¼Œé¢„è®¡å¯è¾¾åˆ° **8.5/10** çš„æ¶æ„è¯„åˆ†
