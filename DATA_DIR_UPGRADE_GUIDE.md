# æ•°æ®ç›®å½•å‡çº§æŒ‡å—

## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ

æ­¤æ›´æ–°å°† Save-Restricted-Bot çš„æ•°æ®å­˜å‚¨ä»é¡¹ç›®ç›¸å¯¹è·¯å¾„ `data/` è¿ç§»åˆ°ç³»ç»Ÿçº§ç‹¬ç«‹ç›®å½• `/data/save_restricted_bot/`ï¼Œå®ç°æ›´å¥½çš„æ•°æ®éš”ç¦»å’ŒæŒä¹…åŒ–ã€‚

## ğŸ¯ æ›´æ–°å†…å®¹

### 1. æ•°æ®å­˜å‚¨ç‹¬ç«‹åŒ–

- **æ—§è·¯å¾„**: `./data/` (é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„)
- **æ–°è·¯å¾„**: `/data/save_restricted_bot/` (ç³»ç»Ÿçº§ç»å¯¹è·¯å¾„)

**ä¼˜åŠ¿**:
- âœ… é¿å…ä¸å…¶ä»–ç¨‹åºæ•°æ®å†²çª
- âœ… ç³»ç»Ÿçº§ç‹¬ç«‹å­˜å‚¨ï¼Œæ›´å®‰å…¨
- âœ… ä¾¿äºé›†ä¸­ç®¡ç†å’Œå¤‡ä»½
- âœ… Docker å®¹å™¨é‡å»ºæ—¶æ•°æ®æŒä¹…åŒ–æ›´å¯é 

### 2. å¯åŠ¨æ—¶é…ç½®è‡ªåŠ¨åˆå§‹åŒ–

ç¨‹åºå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

- å¦‚æœ `config.json` ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºåŒ…å«é»˜è®¤å­—æ®µçš„ç©ºé…ç½®
- å¦‚æœ `watch_config.json` ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºç©ºç›‘æ§é…ç½®
- å·²å­˜åœ¨çš„é…ç½®æ–‡ä»¶ä¸ä¼šè¢«è¦†ç›–

### 3. ç½‘é¡µç¬”è®°å¤šåª’ä½“å®¹é‡é™åˆ¶

- **æ–°é™åˆ¶**: æ¯æ¡ç¬”è®°æœ€å¤šæ”¯æŒ **9 å¼ **åª’ä½“ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰
- **éªŒè¯æœºåˆ¶**: 
  - æ•°æ®åº“å±‚é¢éªŒè¯ (`database.py`)
  - åª’ä½“ç»„å¤„ç†æ—¶éªŒè¯ (`main.py`)
- **è¶…å‡ºå¤„ç†**: è¶…è¿‡ 9 å¼ çš„åª’ä½“ä¼šè¢«è‡ªåŠ¨å¿½ç•¥å¹¶è®°å½•è­¦å‘Š

### 4. ç½‘é¡µæœç´¢ UI ä¼˜åŒ–

- **å¯æŠ˜å è®¾è®¡**: æœç´¢æ¡†é»˜è®¤æ”¶èµ·ï¼Œåªæ˜¾ç¤ºæœç´¢å›¾æ ‡ ğŸ”
- **ç‚¹å‡»å±•å¼€**: ç‚¹å‡»æœç´¢å›¾æ ‡å±•å¼€æœç´¢è¾“å…¥æ¡†
- **è‡ªåŠ¨èšç„¦**: å±•å¼€åè‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
- **æ™ºèƒ½æ”¶èµ·**: ç‚¹å‡»å¤–éƒ¨ä¸”è¾“å…¥æ¡†ä¸ºç©ºæ—¶è‡ªåŠ¨æ”¶èµ·

## ğŸ“‚ æ–°æ•°æ®ç›®å½•ç»“æ„

```
/data/save_restricted_bot/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.json              # Bot é…ç½®ï¼ˆTOKEN, ID, HASH, STRINGï¼‰
â”‚   â””â”€â”€ watch_config.json        # ç›‘æ§ä»»åŠ¡é…ç½®
â”œâ”€â”€ media/                       # åª’ä½“æ–‡ä»¶ï¼ˆå›¾ç‰‡/è§†é¢‘ç¼©ç•¥å›¾ï¼‰
â”œâ”€â”€ logs/                        # æ—¥å¿—æ–‡ä»¶ï¼ˆé¢„ç•™ï¼‰
â””â”€â”€ notes.db                     # ç¬”è®°æ•°æ®åº“
```

## ğŸš€ å‡çº§æ­¥éª¤

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨è¿ç§»ï¼ˆæ¨èï¼‰

ä½¿ç”¨æä¾›çš„è¿ç§»è„šæœ¬è‡ªåŠ¨è¿ç§»æ•°æ®ï¼š

```bash
# è¿è¡Œè¿ç§»è„šæœ¬
sudo python3 migrate_to_system_data_dir.py
```

**æ³¨æ„**: éœ€è¦ sudo æƒé™æ¥åˆ›å»º `/data/save_restricted_bot/` ç›®å½•

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¿ç§»

```bash
# 1. åˆ›å»ºæ–°æ•°æ®ç›®å½•
sudo mkdir -p /data/save_restricted_bot/{config,media,logs}

# 2. å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp data/config/config.json /data/save_restricted_bot/config/
sudo cp data/config/watch_config.json /data/save_restricted_bot/config/

# 3. å¤åˆ¶æ•°æ®åº“
sudo cp data/notes.db /data/save_restricted_bot/

# 4. å¤åˆ¶åª’ä½“æ–‡ä»¶
sudo cp -r data/media/* /data/save_restricted_bot/media/

# 5. è®¾ç½®æƒé™ï¼ˆæ ¹æ®å®é™…è¿è¡Œç”¨æˆ·è°ƒæ•´ï¼‰
sudo chown -R $(whoami):$(whoami) /data/save_restricted_bot/
```

### æ–¹å¼ä¸‰ï¼šDocker ç”¨æˆ·

Docker ç”¨æˆ·æ— éœ€æ‰‹åŠ¨è¿ç§»ï¼Œåªéœ€æ›´æ–°é…ç½®ï¼š

1. æ›´æ–° `docker-compose.yml`ï¼ˆå·²åœ¨æ­¤æ¬¡æ›´æ–°ä¸­å®Œæˆï¼‰
2. ç¡®ä¿å®¿ä¸»æœºç›®å½•å­˜åœ¨ï¼š
   ```bash
   sudo mkdir -p /data/save_restricted_bot
   ```
3. é‡æ–°æ„å»ºå¹¶å¯åŠ¨å®¹å™¨ï¼š
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

å®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„å­ç›®å½•å’Œé…ç½®æ–‡ä»¶ã€‚

## âš™ï¸ é…ç½®æ›´æ–°

### Docker Compose é…ç½®

`docker-compose.yml` å·²æ›´æ–°ä¸ºï¼š

```yaml
volumes:
  - /data/save_restricted_bot:/data/save_restricted_bot
environment:
  - DATA_DIR=/data/save_restricted_bot
```

### ç¯å¢ƒå˜é‡

å¦‚æœæ‚¨ä½¿ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šæ•°æ®ç›®å½•ï¼Œè¯·æ›´æ–°ï¼š

**æ—§é…ç½®**:
```bash
export DATA_DIR=data
```

**æ–°é…ç½®**:
```bash
export DATA_DIR=/data/save_restricted_bot
# æˆ–è€…ä¸è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
```

## âœ… éªŒè¯è¿ç§»

å¯åŠ¨ç¨‹åºåï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

1. **é…ç½®æ–‡ä»¶åŠ è½½æ­£å¸¸**
   ```bash
   # å¯åŠ¨æ—¶åº”çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
   # âœ… å·²åŠ è½½é…ç½®æ–‡ä»¶: /data/save_restricted_bot/config/config.json
   ```

2. **ç›‘æ§ä»»åŠ¡æ˜¾ç¤ºæ­£å¸¸**
   - åœ¨ Telegram ä¸­å‘é€ `/watch` æŸ¥çœ‹ç›‘æ§ä»»åŠ¡åˆ—è¡¨

3. **ç½‘é¡µç¬”è®°æ­£å¸¸è®¿é—®**
   - è®¿é—® `http://your-server:5000`
   - æ£€æŸ¥ç°æœ‰ç¬”è®°æ˜¯å¦æ˜¾ç¤º
   - æµ‹è¯•æœç´¢åŠŸèƒ½

4. **æ–°ç¬”è®°æ­£å¸¸è®°å½•**
   - è§¦å‘ä¸€æ¡æ–°çš„è®°å½•æ¨¡å¼æ¶ˆæ¯
   - æ£€æŸ¥æ˜¯å¦æ­£å¸¸ä¿å­˜åˆ°æ•°æ®åº“

## ğŸ—‘ï¸ æ¸…ç†æ—§æ•°æ®

**é‡è¦**: åªæœ‰åœ¨ç¡®è®¤æ–°æ•°æ®ç›®å½•å·¥ä½œæ­£å¸¸åï¼Œæ‰åˆ é™¤æ—§æ•°æ®ï¼

```bash
# 1. å…ˆå¤‡ä»½æ—§æ•°æ®ï¼ˆå¼ºçƒˆæ¨èï¼‰
tar -czf data_backup_$(date +%Y%m%d).tar.gz data/

# 2. ç¡®è®¤å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸ
ls -lh data_backup_*.tar.gz

# 3. åˆ é™¤æ—§æ•°æ®ç›®å½•
rm -rf data/
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æƒé™ä¸è¶³

**ç—‡çŠ¶**: å¯åŠ¨æ—¶æŠ¥é”™ "Permission denied"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç›®å½•æ‰€æœ‰æƒ
ls -la /data/save_restricted_bot/

# ä¿®æ”¹æ‰€æœ‰æƒä¸ºè¿è¡Œç”¨æˆ·
sudo chown -R your_user:your_user /data/save_restricted_bot/

# æˆ–è€…è®¾ç½®å®½æ¾æƒé™ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
sudo chmod -R 777 /data/save_restricted_bot/
```

### é—®é¢˜ 2: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶

**ç—‡çŠ¶**: å¯åŠ¨æ—¶æç¤º "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls -la /data/save_restricted_bot/config/
   ```

2. å¦‚æœä¸å­˜åœ¨ï¼Œç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºï¼Œç„¶åæ‰‹åŠ¨å¡«å…¥ bot å‡­è¯ï¼š
   ```bash
   sudo nano /data/save_restricted_bot/config/config.json
   ```

### é—®é¢˜ 3: åª’ä½“æ–‡ä»¶æ˜¾ç¤º 404

**ç—‡çŠ¶**: ç½‘é¡µç¬”è®°ä¸­å›¾ç‰‡æ— æ³•æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åª’ä½“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls -la /data/save_restricted_bot/media/
   ```

2. å¦‚æœåª’ä½“æ–‡ä»¶åœ¨æ—§ç›®å½•ï¼Œé‡æ–°è¿è¡Œè¿ç§»è„šæœ¬

3. æ£€æŸ¥ Flask app æ˜¯å¦æ­£ç¡®è®¾ç½® `DATA_DIR`

### é—®é¢˜ 4: Docker å®¹å™¨å†…è·¯å¾„é”™è¯¯

**ç—‡çŠ¶**: Docker å®¹å™¨å¯åŠ¨åæ‰¾ä¸åˆ°æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ volume æŒ‚è½½ï¼š
   ```bash
   docker inspect save-restricted-bot | grep -A 10 Mounts
   ```

2. ç¡®ä¿å®¿ä¸»æœºç›®å½•å­˜åœ¨ä¸”æœ‰æ•°æ®

3. ç¡®è®¤ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®ï¼š
   ```bash
   docker exec save-restricted-bot env | grep DATA_DIR
   ```

## ğŸ“ å…¼å®¹æ€§è¯´æ˜

- **å‘åå…¼å®¹**: ä»£ç ä»ç„¶æ”¯æŒä»æ ¹ç›®å½•çš„ `config.json` å’Œ `watch_config.json` è¯»å–é…ç½®ï¼ˆä¼˜å…ˆçº§ä½äº data/config/ ç›®å½•ï¼‰
- **ç¯å¢ƒå˜é‡ä¼˜å…ˆ**: å¦‚æœè®¾ç½®äº† `DATA_DIR` ç¯å¢ƒå˜é‡ï¼Œä¼šä½¿ç”¨æŒ‡å®šçš„ç›®å½•
- **é»˜è®¤æ–°è·¯å¾„**: æœªè®¾ç½®ç¯å¢ƒå˜é‡æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ `/data/save_restricted_bot/`

## ğŸ†• æ–°åŠŸèƒ½ä½¿ç”¨

### 1. å¤šåª’ä½“å®¹é‡é™åˆ¶

Record mode ç°åœ¨è‡ªåŠ¨é™åˆ¶æ¯æ¡ç¬”è®°æœ€å¤š 9 å¼ åª’ä½“ï¼š

```python
# æ•°æ®åº“å±‚é¢è‡ªåŠ¨éªŒè¯
add_note(..., media_list=[...])  # è‡ªåŠ¨æ£€æŸ¥ len(media_list) <= 9

# è¶…å‡ºæ—¶ä¼šæŠ›å‡º ValueError
```

### 2. æŠ˜å æœç´¢æ¡†

ç½‘é¡µç¬”è®°ç•Œé¢çš„æœç´¢æ¡†ï¼š
- é»˜è®¤åªæ˜¾ç¤º ğŸ” å›¾æ ‡
- ç‚¹å‡»å›¾æ ‡å±•å¼€è¾“å…¥æ¡†
- ç‚¹å‡»å¤–éƒ¨è‡ªåŠ¨æ”¶èµ·ï¼ˆè¾“å…¥æ¡†ä¸ºç©ºæ—¶ï¼‰
- å¦‚æœæœ‰æœç´¢è¯ï¼Œå±•å¼€çŠ¶æ€ä¼šä¿æŒ

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆå¯åŠ¨æ—¶çš„ stdoutï¼‰
2. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤æ–‡ä»¶å’Œç›®å½•æƒé™
4. æäº¤ Issue åˆ° GitHub ä»“åº“

## ğŸ”„ å›é€€åˆ°æ—§ç‰ˆæœ¬

å¦‚æœéœ€è¦å›é€€ï¼š

1. æ¢å¤å¤‡ä»½çš„ `data/` ç›®å½•
2. å›é€€ä»£ç åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
3. é‡å¯æœåŠ¡

```bash
# æ¢å¤å¤‡ä»½
tar -xzf data_backup_YYYYMMDD.tar.gz

# å›é€€ä»£ç 
git checkout <previous-commit>

# é‡å¯æœåŠ¡
systemctl restart your-bot-service
# æˆ–
docker-compose restart
```

## ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯

- **æ›´æ–°ç‰ˆæœ¬**: v2.2.0
- **æ›´æ–°æ—¥æœŸ**: 2024
- **å…¼å®¹æ€§**: å‘åå…¼å®¹ v2.1.x

---

**é‡è¦æé†’**: 
- åŠ¡å¿…å…ˆå¤‡ä»½ç°æœ‰æ•°æ®å†è¿›è¡Œå‡çº§
- ç”Ÿäº§ç¯å¢ƒå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- å‡çº§åç¡®è®¤åŠŸèƒ½æ­£å¸¸å†åˆ é™¤æ—§æ•°æ®ç›®å½•
