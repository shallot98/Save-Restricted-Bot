{# 笔记卡片组件 - Jinja2 宏 #}
{# 使用方式: {% from "components/note_card.html" import render_note_card %} #}
{# 调用: {{ render_note_card(note, viewer_url, search_query) }} #}

{% import "components/icons.html" as icons %}

{% macro render_note_media_img(media_path, alt_text='Note image') %}
{% set raw_media_path = media_path | default('', true) %}
{% set img_url = raw_media_path if (raw_media_path.startswith('http://') or raw_media_path.startswith('https://') or raw_media_path.startswith('/media/')) else '/media/' ~ (raw_media_path | urlencode) %}
<div class="note-media-skeleton skeleton-loader absolute inset-0" aria-hidden="true"></div>
<img src="{{ img_url }}"
	     alt="{{ alt_text }}"
	     loading="lazy"
	     class="note-media-img absolute inset-0 w-full h-full object-cover opacity-0 image-loading"
	     data-note-media-img
	     onload="this.classList.remove('opacity-0','image-loading'); this.classList.add('image-loaded'); if (this.previousElementSibling) this.previousElementSibling.remove();"
	     onerror="this.classList.remove('opacity-0','image-loading'); this.classList.add('image-error'); if (this.previousElementSibling) this.previousElementSibling.remove();">
{% endmacro %}

{% macro render_note_card(note, viewer_url='', search_query='') %}
<div x-data='noteCard({
        id: {{ note.id }},
        isFavorite: {{ note.is_favorite|tojson }},
        mediaPaths: {{ note.media_paths|tojson if note.media_paths else "[]" }},
        mediaPath: {{ note.media_path|tojson if note.media_path else "null" }},
        dnCount: {{ note.all_dns|length if note.all_dns else 0 }},
        viewerUrl: {{ viewer_url|tojson }},
        dns: {{ note.all_dns|tojson if note.all_dns else "[]" }}
     })'
     class="note-card bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
    <!-- 图片 -->
		    {% if note.media_paths and note.media_paths|length > 0 %}
		    {% set media_count = note.media_paths|length %}
		    <div class="relative bg-gray-100 dark:bg-gray-700 overflow-hidden">
		        {% if media_count == 1 %}
		        {# 单图：使用响应式宽高比，与多图保持一致 #}
		        <div class="relative overflow-hidden cursor-pointer w-full h-full" data-note-media-container @click="openGallery(0)">
		            {{ render_note_media_img(note.media_paths[0]) }}
		        </div>
			        {% elif media_count == 2 %}
			        {# 2图：左右并排，使用响应式宽高比 #}
			        <div class="grid grid-cols-2 grid-rows-1 gap-px bg-gray-200 dark:bg-gray-600 w-full" data-note-media-container>
			            {% for media_path in note.media_paths[:2] %}
			            <div class="relative overflow-hidden cursor-pointer w-full h-full" @click="openGallery({{ loop.index0 }})">
			                {{ render_note_media_img(media_path) }}
		            </div>
		            {% endfor %}
		        </div>
			        {% elif media_count == 3 %}
			        {# 3图：左边大图，右边两个小图 #}
			        <div class="grid grid-cols-2 grid-rows-1 gap-px bg-gray-200 dark:bg-gray-600 w-full" data-note-media-container>
			            {# 左边大图 #}
			            <div class="relative overflow-hidden cursor-pointer w-full h-full" @click="openGallery(0)">
			                {{ render_note_media_img(note.media_paths[0]) }}
			            </div>
			            {# 右边两个小图 #}
			            <div class="grid grid-rows-2 gap-px h-full">
			                {% for media_path in note.media_paths[1:3] %}
			                <div class="relative overflow-hidden cursor-pointer w-full h-full" @click="openGallery({{ loop.index }})">
			                    {{ render_note_media_img(media_path) }}
		                </div>
		                {% endfor %}
		            </div>
		        </div>
		        {% else %}
		        {# 4+图：2x2 网格布局 #}
		        <div class="grid grid-cols-2 grid-rows-2 gap-px bg-gray-200 dark:bg-gray-600 w-full" data-note-media-container>
		            {% for media_path in note.media_paths[:4] %}
		            <div class="overflow-hidden cursor-pointer relative w-full h-full" @click="openGallery({{ loop.index0 }})">
		                {{ render_note_media_img(media_path) }}
		                {% if loop.last and media_count > 4 %}
		                <div class="absolute inset-0 bg-black/60 text-white flex items-center justify-center text-lg font-semibold">
		                    +{{ media_count - 4 }}
	                </div>
	                {% endif %}
	            </div>
	            {% endfor %}
	        </div>
	        {% endif %}

			    </div>
			    {% elif note.media_type == 'photo' %}
			    <div class="relative bg-gray-100 dark:bg-gray-700 overflow-hidden cursor-pointer w-full h-full" data-note-media-container @click="openGallery(0)">
		        {{ render_note_media_img(note.media_path) }}
		    </div>
		    {% endif %}

    <!-- 内容 -->
    <div class="p-4">
        <!-- 来源标签 -->
        <div class="flex items-center justify-between mb-2">
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400">
                {% if search_query %}
                    {{ (note.source_name or note.source_chat_id) | highlight(search_query) }}
                {% else %}
                    {{ note.source_name or note.source_chat_id }}
                {% endif %}
            </span>
	            <button type="button"
	                    @click="toggleFavorite()"
	                    x-ref="favoriteBtn"
	                    :disabled="isTogglingFavorite"
	                    class="note-favorite-btn group p-1 rounded-full bg-transparent hover:bg-transparent dark:hover:bg-transparent transition-colors"
	                    :class="{ 'is-favorite': isFavorite, 'is-toggling': isTogglingFavorite }"
	                    :aria-pressed="isFavorite.toString()"
	                    title="收藏/取消收藏">
                    <span x-cloak
                          x-show="isFavorite"
                          x-transition:enter="transition ease-out duration-200"
                          x-transition:enter-start="opacity-0 scale-50"
                          x-transition:enter-end="opacity-100 scale-100">
	                    {{ icons.icon_star_solid(class="w-6 h-6 text-yellow-500 fill-current star-fill") }}
                    </span>
                    <span x-cloak
                          x-show="!isFavorite"
                          x-transition:enter="transition ease-out duration-150"
                          x-transition:enter-start="opacity-0 scale-95"
                          x-transition:enter-end="opacity-100 scale-100">
                        {{ icons.icon_star_outline(class="w-6 h-6 text-gray-400 group-hover:text-yellow-500 transition-colors") }}
                    </span>
                </button>
        </div>

        <!-- 文本内容 -->
        {% if note.message_text %}
        <div class="mb-3">
            <p id="text-{{ note.id }}" 
               class="text-gray-700 dark:text-gray-300 text-sm line-clamp-3 transition-all duration-200">
                {% if search_query %}
                    {{ note.message_text | highlight(search_query) }}
                {% else %}
                    {{ note.message_text }}
                {% endif %}
            </p>
            <button id="expand-btn-{{ note.id }}" 
                    @click="toggleText()" 
                    class="text-primary-600 dark:text-primary-400 text-xs mt-1 hover:underline hidden"
                    x-text="isExpanded ? '收起 ▲' : '展开全文 ▼'">
            </button>
        </div>
        {% endif %}

        <!-- 底部信息 -->
        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-3">
            <div class="flex items-center gap-1">
                {{ icons.icon_clock(class="w-3 h-3") }}
                <span>{{ note.timestamp }}</span>
            </div>
            <span>#{{ note.id }}</span>
        </div>

        <!-- 操作按钮 -->
        <div class="flex gap-2">

            {% if note.all_dns and note.all_dns|length > 0 %}
            <button @click="calibrate()"
                    :disabled="isCalibrating"
                    class="flex-1 px-3 py-1.5 bg-green-500 hover:bg-green-600 disabled:bg-green-300 text-white text-xs rounded-lg transition flex items-center justify-center gap-1">
                <span x-show="isCalibrating" class="animate-spin w-3 h-3 border-2 border-white border-t-transparent rounded-full"></span>
                <span x-text="isCalibrating ? '校准中...' : '校准{% if note.all_dns|length > 1 %}({{ note.all_dns|length }}){% endif %}'">校准</span>
            </button>
            {% set valid_dns = note.all_dns|selectattr('dn')|list %}
            {% if valid_dns|length > 0 %}
                {% if valid_dns|length == 1 %}
                <a href="{{ viewer_url }}{{ valid_dns[0].dn }}" target="_blank"
                   class="flex-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg text-center transition">
                    观看
                </a>
                {% else %}
                <button @click="showWatchOptions()"
                        class="flex-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition">
                    观看({{ valid_dns|length }})
                </button>
                {% endif %}
            {% endif %}
            {% endif %}
            <button @click="edit()"
                    class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded-lg transition">
                编辑
            </button>
            <button @click="deleteNote()"
                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg transition">
                删除
            </button>
        </div>
    </div>
</div>
{% endmacro %}
