{# 笔记卡片组件 - Jinja2 宏 #}
{# 使用方式: {% from "components/note_card.html" import render_note_card %} #}
{# 调用: {{ render_note_card(note, viewer_url, search_query) }} #}

{% macro render_note_card(note, viewer_url='', search_query='') %}
<div class="note-card bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
    <!-- 图片 -->
    {% if note.media_paths and note.media_paths|length > 0 %}
    <div class="relative aspect-video bg-gray-100 dark:bg-gray-700">
        <img src="/media/{{ note.media_paths[0] | urlencode }}"
             alt="Note image"
             loading="lazy"
             class="w-full h-full object-cover cursor-pointer"
             onclick="openImageGallery({{ note.id }}, {{ note.media_paths|tojson }})">
        {% if note.media_paths|length > 1 %}
        <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded cursor-pointer flex items-center gap-1"
             onclick="openImageGallery({{ note.id }}, {{ note.media_paths|tojson }})">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            {{ note.media_paths|length }}
        </div>
        {% endif %}
    </div>
    {% elif note.media_type == 'photo' %}
    <div class="relative aspect-video bg-gray-100 dark:bg-gray-700">
        <img src="/media/{{ note.media_path | urlencode }}"
             alt="Note image"
             loading="lazy"
             class="w-full h-full object-cover cursor-pointer"
             onclick="openImageModal(this.src)">
    </div>
    {% endif %}

    <!-- 内容 -->
    <div class="p-4">
        <!-- 来源标签 -->
        <div class="flex items-center justify-between mb-2">
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400">
                {% if search_query %}
                    {{ (note.source_name or note.source_chat_id) | highlight(search_query) }}
                {% else %}
                    {{ note.source_name or note.source_chat_id }}
                {% endif %}
            </span>
            <button onclick="toggleFavorite({{ note.id }}, this)" class="group p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="收藏/取消收藏">
                {% if note.is_favorite %}
                <svg class="w-6 h-6 text-yellow-500 fill-current" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
                {% else %}
                <svg class="w-6 h-6 text-gray-400 group-hover:text-yellow-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
                {% endif %}
            </button>
        </div>

        <!-- 文本内容 -->
        {% if note.message_text %}
        <div class="mb-3">
            <p id="text-{{ note.id }}" class="text-gray-700 dark:text-gray-300 text-sm line-clamp-3 transition-all duration-200">
                {% if search_query %}
                    {{ note.message_text | highlight(search_query) }}
                {% else %}
                    {{ note.message_text }}
                {% endif %}
            </p>
            <button id="expand-btn-{{ note.id }}" onclick="toggleText({{ note.id }})" class="text-primary-600 dark:text-primary-400 text-xs mt-1 hover:underline hidden">
                展开全文 ▼
            </button>
        </div>
        {% endif %}

        <!-- 底部信息 -->
        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-3">
            <div class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>{{ note.timestamp }}</span>
            </div>
            <span>#{{ note.id }}</span>
        </div>

        <!-- 操作按钮 -->
        <div class="flex gap-2">
            {% if note.all_dns and note.all_dns|length > 0 %}
            <button onclick="calibrateNote({{ note.id }}, {{ note.all_dns|length }}, this)"
                    class="flex-1 px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition">
                校准{% if note.all_dns|length > 1 %}({{ note.all_dns|length }}){% endif %}
            </button>
            {% set valid_dns = note.all_dns|selectattr('dn')|list %}
            {% if valid_dns|length > 0 %}
                {% if valid_dns|length == 1 %}
                <a href="{{ viewer_url }}{{ valid_dns[0].dn }}" target="_blank"
                   class="flex-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg text-center transition">
                    观看
                </a>
                {% else %}
                <button onclick="showWatchOptions(this)"
                        data-note-id="{{ note.id }}"
                        data-dns='{{ valid_dns|tojson }}'
                        class="flex-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition">
                    观看({{ valid_dns|length }})
                </button>
                {% endif %}
            {% endif %}
            {% endif %}
            <button onclick="editNote({{ note.id }})"
                    class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded-lg transition">
                编辑
            </button>
            <button onclick="deleteNote({{ note.id }}, this)"
                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg transition">
                删除
            </button>
        </div>
    </div>
</div>
{% endmacro %}
