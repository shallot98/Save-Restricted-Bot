<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®°ç®¡ç† - Telegram ç¬”è®°</title>
    <!-- å…¨å±€æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/main.min.css?v=2.2">
    <!-- ç¬”è®°é¡µé¢ä¸“ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/pages/notes.min.css?v=2.0">
</head>
<body>
    <div class="app-container">
        <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">ğŸ“</div>
                <div class="sidebar-title">Telegram ç¬”è®°</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-text">é¦–é¡µ</span>
                    </a>
                    <a href="/notes?page=1" class="nav-item {% if request.path == '/notes' %}active{% endif %}">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span class="nav-text">æˆ‘çš„ç¬”è®°</span>
                        <span class="nav-badge">{{ total_count }}</span>
                    </a>
                    <a href="/notes?favorite=1" class="nav-item">
                        <span class="nav-icon">â­</span>
                        <span class="nav-text">æ”¶è—ç¬”è®°</span>
                    </a>
                    <a href="/admin/calibration/queue" class="nav-item">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span class="nav-text">æ•°æ®ç»Ÿè®¡</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">ç³»ç»Ÿè®¾ç½®</div>
                    <a href="/admin" class="nav-item">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-text">åŸºç¡€è®¾ç½®</span>
                    </a>
                    <a href="/admin/calibration" class="nav-item">
                        <span class="nav-icon">ğŸ”§</span>
                        <span class="nav-text">è‡ªåŠ¨æ ¡å‡†</span>
                    </a>
                    <a href="/admin/webdav" class="nav-item">
                        <span class="nav-icon">â˜ï¸</span>
                        <span class="nav-text">äº‘ç«¯å­˜å‚¨</span>
                    </a>
                    <a href="/admin/viewer" class="nav-item">
                        <span class="nav-icon">ğŸ¬</span>
                        <span class="nav-text">è§‚çœ‹è®¾ç½®</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">è´¦æˆ·</div>
                    <a href="/logout" class="nav-item">
                        <span class="nav-icon">ğŸšª</span>
                        <span class="nav-text">é€€å‡ºç™»å½•</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-toggle" id="sidebarToggleBtn" onclick="toggleSidebar()">
                    <span id="sidebarToggleText">æ”¶èµ·ä¾§è¾¹æ </span>
                </button>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <header class="topbar">
                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button class="topbar-action" onclick="toggleMobileSidebar()">
                    <span>â˜°</span>
                </button>

                <!-- æœç´¢æ å®¹å™¨ -->
                <div class="topbar-search-container">
                    <button class="topbar-action search-toggle-btn" onclick="toggleSearch()">
                        <span>ğŸ”</span>
                    </button>
                    <div class="topbar-search" id="topbarSearch">
                        <span class="topbar-search-icon">ğŸ”</span>
                        <input type="text" placeholder="æœç´¢ç¬”è®°å†…å®¹æˆ–æ¥æº..." id="topSearchInput" inputmode="search" autocomplete="off" autocapitalize="none">
                    </div>
                </div>

                <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’®ç»„ -->
                <div class="topbar-actions">
                    <button class="topbar-action" onclick="toggleFilter()">
                        <span>ğŸ¯</span>
                    </button>
                    <button class="topbar-action" onclick="toggleTheme()">
                        <span>ğŸŒ™</span>
                    </button>
                    <button class="topbar-action">
                        <span>ğŸ””</span>
                        <span class="topbar-action-badge"></span>
                    </button>
                    <!-- ç”¨æˆ·èœå• -->
                    <div class="user-menu" onclick="toggleUserMenu()">
                        <div class="user-avatar">A</div>
                        <div class="user-info">
                            <div class="user-name">{{ session.username or 'Admin' }}</div>
                            <div class="user-role">ç®¡ç†å‘˜</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- é¡µé¢å†…å®¹ -->
            <div class="page-container">
                {% if request.args.get('page') or request.args.get('search') or request.args.get('source') or request.args.get('favorite') %}
                <!-- ç¬”è®°æµè§ˆæ¨¡å¼ -->
                <!-- é¡µé¢æ ‡é¢˜ -->
                <div class="page-header">
                    <h1 class="page-title">ğŸ“‹ æˆ‘çš„ç¬”è®°</h1>
                    <p class="page-subtitle">ç®¡ç†å’ŒæŸ¥çœ‹æ‚¨ä¿å­˜çš„æ‰€æœ‰ Telegram ç¬”è®°</p>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-icon primary">ğŸ“Š</div>
                        <div class="stat-content">
                            <div class="stat-label">æ€»ç¬”è®°æ•°</div>
                            <div class="stat-value">{{ total_count }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">ğŸ“‚</div>
                        <div class="stat-content">
                            <div class="stat-label">æ¥æºæ•°é‡</div>
                            <div class="stat-value">{{ sources|length }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon info">ğŸ“„</div>
                        <div class="stat-content">
                            <div class="stat-label">å½“å‰é¡µç </div>
                            <div class="stat-value">{{ current_page }}/{{ total_pages }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">â­</div>
                        <div class="stat-content">
                            <div class="stat-label">æ”¶è—ç¬”è®°</div>
                            <div class="stat-value">{{ notes|selectattr('is_favorite')|list|length }}</div>
                        </div>
                    </div>
                </div>

                <!-- ç­›é€‰é¢æ¿ -->
                <div class="filter-panel {% if search_query or selected_source or date_from or date_to or favorite_only %}active{% endif %}" id="filterPanel">
                    <div class="filter-header">
                        <div class="filter-title">
                            <span>ğŸ”</span>
                            <span>é«˜çº§ç­›é€‰</span>
                        </div>
                        {% if search_query or selected_source or date_from or date_to or favorite_only %}
                        <a href="/notes" class="btn btn-sm btn-secondary">æ¸…é™¤ç­›é€‰</a>
                        {% endif %}
                    </div>

                    <!-- ç­›é€‰è¡¨å• -->
                    <form method="GET" action="/notes">
                        <div class="filter-grid">
                            <div class="form-group">
                                <label class="form-label">å…³é”®è¯æœç´¢</label>
                                <input type="text" name="search" class="form-input" placeholder="æœç´¢ç¬”è®°å†…å®¹..." value="{{ search_query or '' }}" inputmode="search" autocomplete="off" autocapitalize="none">
                            </div>

                            {% if sources|length > 0 %}
                            <div class="form-group">
                                <label class="form-label">ç­›é€‰æ¥æº</label>
                                <select name="source" class="form-select">
                                    <option value="">å…¨éƒ¨æ¥æº</option>
                                    {% for source in sources %}
                                    <option value="{{ source.source_chat_id }}" {% if selected_source == source.source_chat_id %}selected{% endif %}>
                                        {{ source.source_name or source.source_chat_id }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <div class="form-group">
                                <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" name="date_from" class="form-input" value="{{ date_from or '' }}" inputmode="none">
                            </div>

                            <div class="form-group">
                                <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" name="date_to" class="form-input" value="{{ date_to or '' }}" inputmode="none">
                            </div>

                            <div class="form-group">
                                <label class="form-label">æ”¶è—ç­›é€‰</label>
                                <select name="favorite" class="form-select">
                                    <option value="">å…¨éƒ¨ç¬”è®°</option>
                                    <option value="1" {% if favorite_only %}selected{% endif %}>ä»…æ”¶è—</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-actions">
                            <button type="submit" class="btn btn-primary">
                                <span>åº”ç”¨ç­›é€‰</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ç¬”è®°å¡ç‰‡ç½‘æ ¼ -->
                {% if notes|length > 0 %}
                <div class="notes-grid">
                    {% for note in notes %}
                    <div class="note-card">
                        <!-- æ”¶è—æŒ‰é’® -->
                        <button class="note-favorite {{ 'active' if note.is_favorite }}" onclick="toggleFavorite({{ note.id }}, this)">
                            {{ 'â˜…' if note.is_favorite else 'â˜†' }}
                        </button>

                        <!-- åª’ä½“å†…å®¹å±•ç¤º -->
                        {% if note.media_paths and note.media_paths|length > 0 %}
                        <div class="note-media">
                            <div class="media-grid count-{{ note.media_paths|length }}">
                                {% for media_path in note.media_paths %}
                                <div class="media-grid-item">
                                    <img src="/media/{{ media_path | urlencode }}" alt="Note image" loading="lazy" decoding="async" onclick="openImageModal(this.src)">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% elif note.media_type == 'photo' %}
                        <div class="note-media">
                            <img src="/media/{{ note.media_path | urlencode }}" alt="Note image" loading="lazy" decoding="async" onclick="openImageModal(this.src)">
                        </div>
                        {% elif note.media_type == 'video' %}
                        <div class="note-media">
                            <img src="/media/{{ note.media_path | urlencode }}" alt="Video thumbnail" loading="lazy" decoding="async">
                            <span class="media-badge">ğŸ“¹ è§†é¢‘</span>
                        </div>
                        {% elif note.media_type == 'animation' %}
                        <div class="note-media">
                            <img src="/media/{{ note.media_path | urlencode }}" alt="GIF thumbnail" loading="lazy" decoding="async">
                            <span class="media-badge">ğŸ¬ GIFåŠ¨å›¾</span>
                        </div>
                        {% endif %}

                        <!-- ç¬”è®°å†…å®¹ -->
                        <div class="note-content">
                            <!-- æ¥æºä¿¡æ¯ -->
                            <div class="note-source">
                                <span class="note-source-badge">{{ note.source_name or note.source_chat_id }}</span>
                                <span class="note-id">#{{ note.id }}</span>
                            </div>

                            <!-- ç¬”è®°æ–‡æœ¬ -->
                            {% if note.message_text %}
                            <div class="note-text" id="text-{{ note.id }}">
                                {{ note.message_text | highlight(search_query) | safe }}
                                <div class="note-text-fade"></div>
                            </div>
                            <span class="note-expand-btn" id="expand-{{ note.id }}" onclick="toggleText({{ note.id }})">å±•å¼€å…¨æ–‡ â–¼</span>
                            {% endif %}

                            <!-- ç¬”è®°åº•éƒ¨æ“ä½œæ  -->
                            <div class="note-footer">
                                <div class="note-time">
                                    <span>ğŸ•’</span>
                                    <span>{{ note.timestamp }}</span>
                                </div>

                                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                                <div class="note-actions">
                                    {% if note.all_dns and note.all_dns|length > 0 %}
                                    <button class="note-action-btn calibrate" onclick="calibrateNote({{ note.id }}, {{ note.all_dns|length }}, this)">
                                        æ ¡å‡†{% if note.all_dns|length > 1 %}({{ note.all_dns|length }}){% endif %}
                                    </button>
                                    {% endif %}

                                    {% if note.all_dns and note.all_dns|length > 0 %}
                                    {% set valid_dns = note.all_dns|selectattr('dn')|list %}
                                    {% if valid_dns|length > 0 %}
                                    <a href="{{ viewer_url }}{{ valid_dns[0].dn }}" class="note-action-btn watch" target="_blank">
                                        è§‚çœ‹
                                    </a>
                                    {% endif %}
                                    {% endif %}

                                    <a href="/edit_note/{{ note.id }}" class="note-action-btn edit">ç¼–è¾‘</a>
                                    <button class="note-action-btn delete" onclick="deleteNote({{ note.id }})">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- åˆ†é¡µ -->
                {% if total_pages > 1 %}
                <div class="pagination">
                    {% if current_page > 1 %}
                    <a href="?page={{ current_page - 1 }}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">
                        â† ä¸Šä¸€é¡µ
                    </a>
                    {% endif %}

                    {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == current_page %}
                    <span class="page-btn active">{{ page_num }}</span>
                    {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                    <a href="?page={{ page_num }}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">
                        {{ page_num }}
                    </a>
                    {% elif page_num == 4 or page_num == total_pages - 3 %}
                    <span class="page-btn ellipsis">...</span>
                    {% endif %}
                    {% endfor %}

                    {% if current_page < total_pages %}
                    <a href="?page={{ current_page + 1 }}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">
                        ä¸‹ä¸€é¡µ â†’
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}
                {% else %}
                <!-- æ¬¢è¿é¡µé¢ -->
                <div class="welcome-section">
                    <div class="welcome-icon">ğŸ“</div>
                    <h1 class="welcome-title">æ¬¢è¿ä½¿ç”¨ Telegram ç¬”è®°ç³»ç»Ÿ</h1>
                    <p class="welcome-text">ä¸€ä¸ªç°ä»£åŒ–çš„ Telegram å†…å®¹ç®¡ç†å¹³å°ï¼Œå¸®åŠ©æ‚¨é«˜æ•ˆç®¡ç†å’ŒæŸ¥çœ‹ä¿å­˜çš„ç¬”è®°</p>

                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div class="welcome-actions">
                        <a href="/notes?page=1" class="btn btn-primary btn-lg">
                            <span>ğŸ“‹</span>
                            <span>æŸ¥çœ‹æ‰€æœ‰ç¬”è®°</span>
                        </a>
                        <a href="/notes?favorite=1" class="btn btn-secondary btn-lg">
                            <span>â­</span>
                            <span>æˆ‘çš„æ”¶è—</span>
                        </a>
                    </div>
                </div>

                <!-- åŠŸèƒ½ä»‹ç»å¡ç‰‡ -->
                <div class="welcome-features-grid">
                    <div class="card">
                        <div class="card-body welcome-feature-card">
                            <div class="welcome-feature-icon">ğŸ“Š</div>
                            <h3 class="welcome-feature-title">æ•°æ®ç»Ÿè®¡</h3>
                            <p class="welcome-feature-text">
                                æ€»è®¡ <strong>{{ total_count }}</strong> æ¡ç¬”è®°<br>
                                æ¥è‡ª <strong>{{ sources|length }}</strong> ä¸ªæ¥æº
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body welcome-feature-card">
                            <div class="welcome-feature-icon">ğŸ”</div>
                            <h3 class="welcome-feature-title">æ™ºèƒ½æœç´¢</h3>
                            <p class="welcome-feature-text">
                                æ”¯æŒå…³é”®è¯æœç´¢ã€æ¥æºç­›é€‰<br>
                                æ—¥æœŸèŒƒå›´å’Œæ”¶è—ç­›é€‰
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body welcome-feature-card">
                            <div class="welcome-feature-icon">ğŸŒ™</div>
                            <h3 class="welcome-feature-title">æš—è‰²æ¨¡å¼</h3>
                            <p class="welcome-feature-text">
                                æŠ¤çœ¼çš„æš—è‰²ä¸»é¢˜<br>
                                ä¸€é”®åˆ‡æ¢ï¼Œè‡ªåŠ¨ä¿å­˜
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal" id="imageModal" onclick="closeImageModal()">
        <button class="modal-close" onclick="closeImageModal()">Ã—</button>
        <img class="modal-image" id="modalImage" onclick="event.stopPropagation()">
    </div>

    <!-- JavaScript Modules (Load in dependency order) -->
    <!-- 1. Utilities (no dependencies) -->
    <script src="/static/js/utils/storage.min.js?v=2.0"></script>
    <script src="/static/js/utils/debounce.min.js?v=2.0"></script>
    <script src="/static/js/utils/network.min.js?v=2.0"></script>

    <!-- 2. Components (depend on utilities) -->
    <script src="/static/js/components/sidebar.min.js?v=2.0"></script>
    <script src="/static/js/components/search.min.js?v=2.0"></script>
    <script src="/static/js/components/modal.min.js?v=2.0"></script>
    <script src="/static/js/components/lazyload.min.js?v=2.0"></script>

    <!-- 3. Page Logic (depends on all above) -->
    <script src="/static/js/pages/notes.min.js?v=2.0"></script>

    <!-- Debug: Verify functions are loaded -->
    <script>
        console.log('toggleMobileSidebar available:', typeof window.toggleMobileSidebar);
        console.log('MobileUIState available:', typeof window.MobileUIState);
    </script>
</body>
</html>
