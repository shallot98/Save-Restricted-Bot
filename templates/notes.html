<!DOCTYPE html>
<html lang="zh-CN">
	<head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	    <meta name="csrf-token" content="{{ csrf_token() }}">
	    <title>我的笔记 - Telegram 笔记</title>

	    <!-- 首屏状态预初始化：在任何样式/框架执行前同步应用主题与侧边栏默认状态，避免闪烁 -->
	    <script nonce="{{ csp_nonce() }}">
	        (function() {
	            var initialState = { sidebarOpen: false, darkMode: false };

                window.ThemeManager = window.ThemeManager || (function() {
                    function readPreference() {
                        try {
                            var savedTheme = localStorage.getItem('theme');
                            if (savedTheme === 'dark') return true;
                            if (savedTheme === 'light') return false;

                            var legacyDarkMode = localStorage.getItem('darkMode');
                            if (legacyDarkMode === 'true') return true;
                            if (legacyDarkMode === 'false') return false;
                        } catch (e) {
                            // ignore
                        }

                        return !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    }

                    function apply(isDark, persist) {
                        var dark = !!isDark;
                        document.documentElement.classList.toggle('dark', dark);
                        if (dark) document.documentElement.setAttribute('data-theme', 'dark');
                        else document.documentElement.removeAttribute('data-theme');

                        if (!persist) return;
                        try {
                            localStorage.setItem('theme', dark ? 'dark' : 'light');
                            localStorage.setItem('darkMode', dark ? 'true' : 'false');
                        } catch (e) {
                            // ignore
                        }
                    }

                    function toggle() {
                        var current = document.documentElement.classList.contains('dark');
                        var next = !current;
                        apply(next, true);
                        return next;
                    }

                    return { readPreference, apply, toggle };
                })();

                window.NotesSidebarStorage = window.NotesSidebarStorage || (function() {
                    function isDesktop() {
                        return window.matchMedia ? window.matchMedia('(min-width: 1024px)').matches : (window.innerWidth >= 1024);
                    }

                    function readOpen() {
                        if (!isDesktop()) return false;
                        try {
                            var raw = localStorage.getItem('mobileUIState');
                            if (!raw) return false;
                            var parsed = JSON.parse(raw);
                            if (!parsed || typeof parsed !== 'object') return false;
                            return parsed.sidebarOpen === true;
                        } catch (e) {
                            return false;
                        }
                    }

                    function writeOpen(open) {
                        if (!isDesktop()) return;
                        try {
                            var stateToSave = { sidebarOpen: !!open, timestamp: Date.now() };
                            localStorage.setItem('mobileUIState', JSON.stringify(stateToSave));
                        } catch (e) {
                            // ignore
                        }
                    }

                    return { isDesktop, readOpen, writeOpen };
                })();

                initialState.darkMode = window.ThemeManager.readPreference();
                window.ThemeManager.apply(initialState.darkMode, false);
                initialState.sidebarOpen = window.NotesSidebarStorage.readOpen();

	            window.__NOTES_INITIAL_STATE__ = initialState;
	        })();
	    </script>

    <!-- 预连接CDN加速 -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- Tailwind CSS (Local) -->
    <script src="{{ url_for('static', filename='js/tailwindcss-3.4.1.js') }}"></script>

	    <script nonce="{{ csp_nonce() }}">
	        // Tailwind 配置必须在加载后设置
	        tailwind.config = {
	            darkMode: 'class',
	            theme: {
	                extend: {
	                    colors: {
	                        primary: {
	                            50: '#eff6ff',
	                            100: '#dbeafe',
	                            200: '#bfdbfe',
	                            300: '#93c5fd',
	                            400: '#60a5fa',
	                            500: '#3b82f6',
	                            600: '#2563eb',
	                            700: '#1d4ed8',
	                            800: '#1e40af',
	                            900: '#1e3a8a',
	                        }
	                    }
	                }
	            }
	        };
	    </script>

    <!-- Alpine.js (Local) -->
    <script defer src="{{ url_for('static', filename='js/alpinejs-3.14.3.min.js') }}"></script>

    <style>
        [x-cloak] { display: none !important; }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 暗色模式滚动条 */
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 卡片悬停效果 */
        .note-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .note-card:hover {
            transform: translateY(-2px);
        }

	        /* 自定义 line-clamp-3 实现 */
	        .line-clamp-3 {
	            display: -webkit-box !important;
	            -webkit-box-orient: vertical !important;
	            -webkit-line-clamp: 3 !important;
	            overflow: hidden !important;
	            text-overflow: ellipsis !important;
	            width: 100% !important;
	            word-break: break-all !important;
	            overflow-wrap: anywhere !important;
	            word-wrap: break-word !important;
	            white-space: normal !important;
	            max-width: 100% !important;
	            min-width: 0 !important;
	            line-height: 1.6 !important;
	        }

	        /* 笔记卡片媒体区：固定宽高比，避免“超长图”拉伸布局 */
	        .note-card [data-note-media-container] {
	            aspect-ratio: 16 / 10;
	            max-height: 300px;
	            overflow: hidden;
	        }

	        .note-card [data-note-media-container] img {
	            width: 100%;
	            height: 100%;
	            object-fit: cover;
	        }

	        @media (max-width: 640px) {
	            .note-card [data-note-media-container] {
	                aspect-ratio: 4 / 3;
	                max-height: 250px;
	            }
	        }

	        /* 确保笔记卡片内容不溢出 */
	        .note-card {
	            min-width: 0;
	            overflow: hidden;
	        }

	        .note-card p {
	            max-width: 100%;
	            min-width: 0;
	            overflow: visible;
	            word-break: break-all;
	            overflow-wrap: anywhere;
	        }

        .note-card * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* 搜索高亮样式 */
        .highlight {
            background-color: #fef08a;
            color: #854d0e;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .dark .highlight {
            background-color: #ca8a04;
            color: #fef3c7;
        }

        /* 笔记文本样式 */
        .note-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #374151; /* gray-700 */
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .dark .note-text {
            color: #d1d5db; /* gray-300 */
        }

        .note-text-fade {
            display: none; /* 默认不显示，仅在折叠时可能需要（如果使用 max-height 方案） */
        }

        .note-expand-btn {
            display: none; /* 默认隐藏，JS检测后显示 */
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #3b82f6; /* primary-500 */
            cursor: pointer;
            font-weight: 500;
        }

        .note-expand-btn:hover {
            color: #2563eb; /* primary-600 */
        }

        /* 图片放大功能样式 */
        .zoom-view-container {
            display: block !important;
            overflow: auto !important;
            text-align: center;
        }
        
        .zoom-view-image {
            max-width: none !important;
            max-height: none !important;
            cursor: zoom-out !important;
            display: inline-block;
            margin: auto;
        }
    </style>

    <!-- 图片画廊功能 - 提前定义确保全局可用 -->
    <script nonce="{{ csp_nonce() }}">
        // 图片画廊相关变量(绑定到window确保全局可访问)
        window.galleryImages = [];
        window.currentGalleryIndex = 0;

        // 图片放大功能
        window.toggleImageZoom = function(imgId) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            // 获取滚动容器 (对于gallery是父div, 对于modal是modal本身)
            const container = img.parentElement;
            
            if (container.classList.contains('zoom-view-container')) {
                // 缩小 (还原)
                container.classList.remove('zoom-view-container');
                img.classList.remove('zoom-view-image');
                img.style.cursor = 'zoom-in';
            } else {
                // 放大
                container.classList.add('zoom-view-container');
                img.classList.add('zoom-view-image');
                img.style.cursor = 'zoom-out';
            }
            // 阻止事件冒泡,防止触发关闭模态框
            if (event) event.stopPropagation();
        };

        window.openImageGallery = function(noteId, mediaPaths, startIndex = 0) {
            console.log('Opening gallery for note:', noteId, mediaPaths);
            window.galleryImages = mediaPaths.map(path => '/media/' + encodeURIComponent(path));
            const requestedIndex = Number.parseInt(startIndex, 10);
            const initialIndex = Number.isFinite(requestedIndex) ? requestedIndex : 0;
            window.currentGalleryIndex = Math.min(
                Math.max(initialIndex, 0),
                Math.max(window.galleryImages.length - 1, 0)
            );

            const modal = document.getElementById('galleryModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // 防止背景滚动
            document.body.style.overflow = 'hidden';

            // 生成缩略图
            const thumbnailsContainer = document.getElementById('galleryThumbnails');
            thumbnailsContainer.innerHTML = '';

            window.galleryImages.forEach((src, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'w-16 h-16 rounded-lg overflow-hidden cursor-pointer border-2 transition-all ' +
                    (index === window.currentGalleryIndex ? 'border-white' : 'border-transparent opacity-60 hover:opacity-100');
                thumb.onclick = () => window.showGalleryImage(index);

                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-full h-full object-cover';
                img.loading = 'lazy';

                thumb.appendChild(img);
                thumbnailsContainer.appendChild(thumb);
            });

            window.showGalleryImage(window.currentGalleryIndex);

            // 键盘导航
            document.addEventListener('keydown', window.handleGalleryKeyboard);
        };

        window.closeGalleryModal = function() {
            const modal = document.getElementById('galleryModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.removeEventListener('keydown', window.handleGalleryKeyboard);

            // 恢复背景滚动
            document.body.style.overflow = '';
        };

        window.showGalleryImage = function(index) {
            if (index < 0 || index >= window.galleryImages.length) return;

            window.currentGalleryIndex = index;
            const img = document.getElementById('galleryImage');
            img.src = window.galleryImages[index];

            // 更新计数器
            document.getElementById('galleryCounter').textContent = `${index + 1} / ${window.galleryImages.length}`;

            // 更新缩略图高亮
            const thumbnails = document.getElementById('galleryThumbnails').children;
            Array.from(thumbnails).forEach((thumb, i) => {
                if (i === index) {
                    thumb.className = thumb.className.replace('border-transparent opacity-60', 'border-white');
                } else {
                    thumb.className = thumb.className.replace('border-white', 'border-transparent opacity-60');
                }
            });

            // 显示/隐藏导航按钮
            document.getElementById('galleryPrev').style.display = index === 0 ? 'none' : 'block';
            document.getElementById('galleryNext').style.display = index === window.galleryImages.length - 1 ? 'none' : 'block';
        };

        window.changeGalleryImage = function(direction) {
            const newIndex = window.currentGalleryIndex + direction;
            if (newIndex >= 0 && newIndex < window.galleryImages.length) {
                window.showGalleryImage(newIndex);
            }
        };

        window.handleGalleryKeyboard = function(e) {
            if (e.key === 'ArrowLeft') {
                window.changeGalleryImage(-1);
            } else if (e.key === 'ArrowRight') {
                window.changeGalleryImage(1);
            } else if (e.key === 'Escape') {
                window.closeGalleryModal();
            }
        };
    </script>
	</head>
	<body class="bg-gray-50 dark:bg-gray-900" x-data="notesApp(window.__NOTES_INITIAL_STATE__)" x-init="init()">

    {# 顶部导航栏 #}
    {% include "components/topbar.html" %}

    <!-- 主容器 -->
    <div class="flex pt-16 pb-16 lg:pb-0">
        {# 侧边栏 #}
        {% include "components/sidebar.html" %}

        <!-- 遮罩层 (移动端) -->
	        <div
	            x-show="sidebarOpen && window.innerWidth < 1024"
	            @click="sidebarOpen = false"
	            x-cloak
	            class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden mt-16"
	        ></div>

        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                
                <!-- 页面标题 (与 Dashboard 保持一致) -->
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                        <div class="p-2 bg-primary-100 dark:bg-primary-900/30 rounded-lg text-primary-600 dark:text-primary-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        我的笔记
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">查看、搜索和管理所有已保存的消息内容</p>
                </div>

                <!-- 搜索结果提示 -->
                {% if search_query %}
                <div class="mb-4 flex items-center gap-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="text-sm text-yellow-800 dark:text-yellow-200">
                        搜索 "<span class="font-semibold">{{ search_query }}</span>" 找到 <span class="font-semibold">{{ total_count }}</span> 条结果
                    </span>
                    <a href="/notes" class="ml-auto text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-200 text-sm font-medium">
                        清除搜索
                    </a>
                </div>
                {% endif %}

                <!-- 筛选栏 -->
                <div class="mb-6 flex flex-wrap gap-2">
                    <button @click="filterFavorite = !filterFavorite"
                            :class="filterFavorite ? 'bg-primary-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300'"
                            class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium hover:shadow-md transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        收藏
                    </button>
                    <button class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm font-medium hover:shadow-md transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        日期筛选
                    </button>
                    <button class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm font-medium hover:shadow-md transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        标签
                    </button>
                </div>

                <!-- 笔记网格 -->
                {% if notes|length > 0 %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    {% from "components/note_card.html" import render_note_card %}
                    {% for note in notes %}
                        {{ render_note_card(note, viewer_url, search_query) }}
                    {% endfor %}
                </div>

                <!-- 分页 -->
                {% from "components/pagination.html" import render_pagination %}
                {{ render_pagination(current_page, total_pages, selected_source) }}
                {% else %}
                <!-- 空状态 -->
                <div class="text-center py-12">
                    <div class="text-gray-200 dark:text-gray-700 mb-4 flex justify-center">
                        <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">还没有笔记</h3>
                    <p class="text-gray-500 dark:text-gray-400">开始使用 Telegram 机器人保存你的第一条笔记吧</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    {# 移动端底部导航栏 #}
    {% include "components/mobile_nav.html" %}

    {# 模态框组件 #}
    {% include "components/modals.html" %}

	    <!-- Scripts -->
	    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
	    <script src="{{ url_for('static', filename='js/components/note-card.js') }}"></script>
	    <script src="{{ url_for('static', filename='js/notes.js') }}"></script>

		    <script nonce="{{ csp_nonce() }}">
			        function notesApp(initialState) {
	                    const resolvedInitial = (initialState && typeof initialState === 'object') ? initialState : {};
                        
                        // 防御性编程：防止 head 脚本执行失败导致对象未定义
                        const theme = window.ThemeManager || {
                            readPreference: function() { 
                                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                            },
                            apply: function(isDark) {
                                document.documentElement.classList.toggle('dark', isDark);
                            },
                            toggle: function() { return false; }
                        };

                        const sidebarStorage = window.NotesSidebarStorage || {
                            isDesktop: function() { return window.innerWidth >= 1024; },
                            readOpen: function() { return false; },
                            writeOpen: function() { }
                        };
	
			            return {
			                sidebarOpen: (resolvedInitial.sidebarOpen === true),
			                showMobileSearch: false,
			                darkMode: (typeof resolvedInitial.darkMode === 'boolean') ? resolvedInitial.darkMode : theme.readPreference(),
			                searchQuery: '',
			                filterFavorite: false,
			                searchTimeout: null,
	
		                init() {
                            try {
	                            theme.apply(this.darkMode, false);
	                            if (!sidebarStorage.isDesktop()) this.sidebarOpen = false;

                                this.$watch('sidebarOpen', (value) => {
                                    if (!sidebarStorage.isDesktop()) return;
                                    sidebarStorage.writeOpen(value);
                                });
                            } catch (e) {
                                console.error('notesApp init error:', e);
                            }
		                },

		                toggleDarkMode() {
		                    this.darkMode = !this.darkMode;
	                        theme.apply(this.darkMode, true);
		                },

                debounceSearch() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        if (this.searchQuery.length > 0) {
                            window.location.href = '/notes?search=' + encodeURIComponent(this.searchQuery);
                        }
                    }, 800);
                }
            }
        }

        // ========================================
        // 图片模态框和画廊功能
        // 绑定到window对象以确保全局可访问(避免Alpine.js冲突)
        // ========================================

        window.openImageModal = function(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // 添加ESC键关闭功能
            document.addEventListener('keydown', window.handleImageModalKeyboard);

            // 防止背景滚动
            document.body.style.overflow = 'hidden';
        };

        window.closeImageModal = function() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // 移除ESC键监听
            document.removeEventListener('keydown', window.handleImageModalKeyboard);

            // 恢复背景滚动
            document.body.style.overflow = '';
        };

        window.handleImageModalKeyboard = function(e) {
            if (e.key === 'Escape') {
                window.closeImageModal();
            }
        };

        // 注意: 图片画廊函数已移至 <head> 中,确保全局早期可用

	        function toggleFavorite(noteId, btn) {
	            NetworkManager.fetchWithRetry('/toggle_favorite/' + noteId, {
	                method: 'POST',
	                headers: { 'Content-Type': 'application/json' }
	            })
	            .then(response => response.json())
	            .then(data => {
                if (data.success) {
                    // 重新构建SVG
                    const isFavorite = btn.querySelector('svg').classList.contains('text-yellow-500');
                    if (isFavorite) {
                        // 变为未收藏 (空心)
                        btn.innerHTML = `
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-yellow-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>`;
                    } else {
                        // 变为已收藏 (实心)
                        btn.innerHTML = `
                        <svg class="w-6 h-6 text-yellow-500 fill-current" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>`;
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function toggleText(noteId) {
            const textEl = document.getElementById('text-' + noteId);
            const btnEl = document.getElementById('expand-btn-' + noteId);

            if (textEl.classList.contains('line-clamp-3')) {
                textEl.classList.remove('line-clamp-3');
                btnEl.textContent = '收起 ▲';
            } else {
                textEl.classList.add('line-clamp-3');
                btnEl.textContent = '展开全文 ▼';
            }
        }

        function showWatchOptions(btn) {
            const modal = document.getElementById('watchModal');
            const optionsList = document.getElementById('watchOptionsList');
            const viewerUrl = '{{ viewer_url }}';
            const validDns = JSON.parse(btn.getAttribute('data-dns'));

            optionsList.innerHTML = '';

            validDns.forEach((dns, index) => {
                const option = document.createElement('a');
                option.href = viewerUrl + encodeURIComponent(dns.dn);
                option.target = '_blank';
                option.className = 'block p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition';

                const fileName = dns.dn || dns.info_hash || '未知文件';
                const displayName = fileName.length > 80 ? fileName.substring(0, 77) + '...' : fileName;

                option.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                ${index + 1}. ${displayName}
                            </div>
                            ${dns.info_hash ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Hash: ${dns.info_hash.substring(0, 16)}...</div>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-blue-500 ml-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>
                `;

                optionsList.appendChild(option);
            });

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeWatchModal() {
            const modal = document.getElementById('watchModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        let currentEditNoteId = null;

        function editNote(noteId) {
            currentEditNoteId = noteId;
            const textEl = document.getElementById('text-' + noteId);
            const textarea = document.getElementById('editTextarea');
            textarea.value = textEl.textContent.trim();
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        window.closeEditModal = function() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            currentEditNoteId = null;
        };

	        window.saveNote = function() {
	            if (!currentEditNoteId) return;

	            const textarea = document.getElementById('editTextarea');
	            const newText = textarea.value.trim();

	            NetworkManager.fetchWithRetry('/api/edit_note/' + currentEditNoteId, {
	                method: 'POST',
	                headers: { 'Content-Type': 'application/json' },
	                body: JSON.stringify({ message_text: newText })
	            })
	            .then(response => response.json())
	            .then(data => {
	                if (data.success) {
	                    const textEl = document.getElementById('text-' + currentEditNoteId);
	                    if (textEl) {
	                        textEl.textContent = newText;
	                        const cardEl = textEl.closest('[x-data]');
	                        if (cardEl && window.Alpine && typeof window.Alpine.$data === 'function') {
	                            const state = window.Alpine.$data(cardEl);
	                            if (state && typeof state === 'object') {
	                                state.isExpanded = false;
	                            }
	                        }
	                        const btn = document.getElementById('expand-btn-' + currentEditNoteId);
	                        if (btn) {
	                            btn.classList.add('hidden');
	                            btn.textContent = '展开全文 ▼';
	                        }
	                        textEl.classList.add('line-clamp-3');
	                        setTimeout(() => {
	                            if (!btn) return;
	                            const collapsedHeight = textEl.clientHeight;
	                            textEl.classList.remove('line-clamp-3');
	                            const expandedHeight = textEl.clientHeight;
	                            textEl.classList.add('line-clamp-3');
	                            if (expandedHeight > collapsedHeight + 1) {
	                                btn.classList.remove('hidden');
	                            }
	                        }, 0);
	                    }
	                    window.closeEditModal();
	                } else {
	                    throw new Error(data.error || '保存失败');
	                }
	            })
	            .catch(error => {
	                alert('保存失败: ' + error.message);
	            });
	        };
	    </script>
</body>
</html>
