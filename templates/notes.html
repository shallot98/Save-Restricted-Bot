<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记管理 - Telegram 笔记</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'notion-gray': '#37352F',
                        'notion-blue': '#0F766E',
                        'notion-bg': '#FFFFFF',
                        'notion-sidebar': '#F7F6F3',
                        'notion-hover': '#F1F1EF',
                        'notion-border': '#E9E9E7',
                        'notion-text': '#787774',
                        'notion-text-light': '#9B9A97'
                    },
                    fontFamily: {
                        'notion': ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-down': 'slideDown 0.2s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .notion-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .notion-card:hover {
            transform: translateY(-2px);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }
        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 60%;
            padding: 0 2px;
            border-radius: 3px;
            font-weight: 500;
        }
    </style>
</head>
<body class="font-notion bg-notion-sidebar text-notion-gray min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-notion-border sticky top-0 z-40 backdrop-blur-lg bg-opacity-95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <button onclick="toggleMenu()" class="md:hidden text-notion-text hover:text-notion-gray transition-colors">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-notion-blue to-teal-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-sticky-note text-white text-sm"></i>
                        </div>
                        <h1 class="text-xl font-semibold text-notion-gray">笔记管理</h1>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleSearch()" class="p-2.5 rounded-lg hover:bg-notion-hover transition-colors text-notion-text">
                        <i class="fas fa-search"></i>
                    </button>
                    <a href="{{ url_for('admin') }}" class="p-2.5 rounded-lg hover:bg-notion-hover transition-colors text-notion-text">
                        <i class="fas fa-cog"></i>
                    </a>
                    <a href="{{ url_for('logout') }}" class="p-2.5 rounded-lg hover:bg-red-50 text-red-500 transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- 侧边栏 -->
        <aside id="sidebar" class="hidden md:flex w-64 bg-white border-r border-notion-border flex-col">
            <div class="p-6 space-y-6">
                <!-- 快速筛选 -->
                <div>
                    <h3 class="text-sm font-medium text-notion-text mb-3">快速筛选</h3>
                    <div class="space-y-2">
                        <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-notion-hover transition-colors {% if not search_query and not start_date and not end_date %}bg-notion-hover text-notion-blue{% endif %}">
                            <i class="fas fa-list w-5"></i>
                            <span class="font-medium">全部笔记</span>
                        </a>
                        {% if search_query or start_date or end_date %}
                        <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-notion-hover transition-colors">
                            <i class="fas fa-times w-5"></i>
                            <span class="font-medium">清除筛选</span>
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- 统计信息 -->
                <div>
                    <h3 class="text-sm font-medium text-notion-text mb-3">统计信息</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-notion-text">总笔记数</span>
                            <span class="text-sm font-semibold text-notion-gray">{{ total_notes }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-notion-text">当前页</span>
                            <span class="text-sm font-semibold text-notion-gray">{{ current_page }} / {{ total_pages }}</span>
                        </div>
                    </div>
                </div>

                <!-- 数据源 -->
                {% if sources %}
                <div>
                    <h3 class="text-sm font-medium text-notion-text mb-3">数据源</h3>
                    <div class="space-y-2">
                        {% for source in sources %}
                        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-notion-sidebar">
                            <i class="fas fa-database text-notion-text text-sm"></i>
                            <span class="text-sm text-notion-gray truncate">{{ source }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- 主内容区域 -->
        <main class="flex-1 max-w-5xl mx-auto p-6">
            <!-- 页面标题和操作 -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-notion-gray mb-1">笔记列表</h2>
                        {% if search_query or start_date or end_date %}
                        <p class="text-sm text-notion-text">
                            <i class="fas fa-filter mr-1"></i>
                            {% if search_query %}"{{ search_query }}" {% endif %}
                            {% if start_date %}{{ start_date }}{% endif %}
                            {% if start_date and end_date %} - {% endif %}
                            {% if end_date %}{{ end_date }}{% endif %}
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <button onclick="toggleSearch()" class="px-4 py-2.5 bg-gradient-to-r from-notion-blue to-teal-600 text-white rounded-xl hover:shadow-lg transition-all duration-200 font-medium">
                            <i class="fas fa-search mr-2"></i>搜索
                        </button>
                        {% if search_query or start_date or end_date %}
                        <a href="{{ url_for('index') }}" class="px-4 py-2.5 rounded-lg hover:bg-notion-hover transition-colors text-notion-text">
                            <i class="fas fa-times mr-2"></i>清除
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 搜索面板 -->
            <div id="searchPanel" class="hidden mb-8 animate-slide-down">
                <div class="bg-white rounded-2xl shadow-sm border border-notion-border p-6">
                    <form method="GET" class="space-y-4">
                        <div class="relative">
                            <input type="text" name="search" value="{{ search_query if search_query else '' }}" 
                                   placeholder="搜索关键词..." 
                                   class="w-full pl-10 pr-4 py-3 bg-notion-sidebar border border-notion-border rounded-xl focus:outline-none focus:ring-2 focus:ring-notion-blue focus:border-transparent transition-all">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-notion-text"></i>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-notion-text mb-2">开始日期</label>
                                <input type="date" name="start_date" value="{{ start_date if start_date else '' }}" 
                                       class="w-full px-3 py-2 bg-notion-sidebar border border-notion-border rounded-lg focus:outline-none focus:ring-2 focus:ring-notion-blue focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-notion-text mb-2">结束日期</label>
                                <input type="date" name="end_date" value="{{ end_date if end_date else '' }}" 
                                       class="w-full px-3 py-2 bg-notion-sidebar border border-notion-border rounded-lg focus:outline-none focus:ring-2 focus:ring-notion-blue focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-notion-blue to-teal-600 text-white rounded-xl hover:shadow-lg transition-all duration-200 font-medium">
                                <i class="fas fa-search mr-2"></i>搜索
                            </button>
                            <button type="button" onclick="clearSearch()" class="px-4 py-2.5 rounded-lg hover:bg-notion-hover transition-colors text-notion-text">
                                <i class="fas fa-times mr-2"></i>清除
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 笔记列表 -->
            {% if notes %}
            <div class="space-y-4">
                {% for note in notes %}
                <div class="notion-card bg-white rounded-2xl shadow-sm border border-notion-border overflow-hidden hover:shadow-md" data-note-id="{{ note.id }}">
                    <div class="p-6">
                        <!-- 笔记头部 -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                {% if note.title %}
                                <h3 class="text-lg font-semibold text-notion-gray mb-2 line-clamp-2">{{ note.title | highlight(search_query) | safe }}</h3>
                                {% else %}
                                <span class="text-notion-text">无标题</span>
                                {% endif %}
                                <div class="flex items-center gap-4 text-sm text-notion-text">
                                    <span><i class="fas fa-clock mr-1"></i>{{ note.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                                    <span><i class="fas fa-database mr-1"></i>{{ note.source }}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <a href="{{ url_for('edit_note', note_id=note.id) }}" class="p-2 rounded-lg hover:bg-blue-50 text-blue-500 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="confirmDelete({{ note.id }})" class="p-2 rounded-lg hover:bg-red-50 text-red-500 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 笔记内容 -->
                        <div class="mb-4">
                            <div id="text-{{ note.id }}" class="text-notion-gray leading-relaxed {% if note.text|length > 300 %}line-clamp-3{% endif %}">
                                {{ note.text | highlight(search_query) | safe }}
                            </div>
                            {% if note.text|length > 300 %}
                            <button onclick="toggleText({{ note.id }})" class="mt-2 text-notion-blue hover:text-notion-blue/80 text-sm font-medium transition-colors">
                                <span id="toggle-{{ note.id }}">展开全文</span>
                                <i class="fas fa-chevron-down ml-1"></i>
                            </button>
                            {% endif %}
                        </div>

                        <!-- 媒体文件 -->
                        {% if note.media_files %}
                        <div class="border-t border-notion-border pt-4">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-photo-video text-notion-text mr-1"></i>
                                <span class="text-sm text-notion-text">附件 ({{ note.media_files|length }})</span>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                {% for media_file in note.media_files %}
                                <div class="relative group cursor-pointer overflow-hidden rounded-lg" onclick="openImageModal('{{ url_for('serve_media', filename=media_file) }}', '{{ media_file }}')">
                                    {% if media_file.endswith(('.jpg', '.jpeg', '.png', '.webp')) %}
                                    <img src="{{ url_for('serve_media', filename=media_file) }}" 
                                         alt="图片" 
                                         class="w-full h-32 object-cover rounded-lg group-hover:scale-105 transition-transform duration-200">
                                    {% elif media_file.endswith('.mp4') %}
                                    <div class="relative overflow-hidden rounded-lg bg-gray-100">
                                        {% if note.media_thumbnails and media_file in note.media_thumbnails %}
                                        <img src="{{ url_for('serve_media', filename=note.media_thumbnails[media_file]) }}" 
                                             alt="视频缩略图" 
                                             class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-200">
                                        {% else %}
                                        <div class="w-full h-32 bg-gray-200 flex items-center justify-center">
                                            <i class="fas fa-video text-gray-400 text-2xl"></i>
                                        </div>
                                        {% endif %}
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 flex items-center justify-center">
                                            <i class="fas fa-play-circle text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-200"></i>
                                        </div>
                                    </div>
                                    {% elif media_file.endswith(('.gif', '.mp4', '.webm')) and media_file != note.media_thumbnails.get(media_file.replace('.mp4', '_gif_thumb.jpg')) %}
                                    <div class="relative overflow-hidden rounded-lg bg-gray-100">
                                        {% if note.media_thumbnails and media_file.replace('.mp4', '_gif_thumb.jpg') in note.media_thumbnails %}
                                        <img src="{{ url_for('serve_media', filename=note.media_thumbnails[media_file.replace('.mp4', '_gif_thumb.jpg')]) }}" 
                                             alt="GIF缩略图" 
                                             class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-200">
                                        {% else %}
                                        <div class="w-full h-32 bg-gray-200 flex items-center justify-center">
                                            <i class="fas fa-film text-gray-400 text-2xl"></i>
                                        </div>
                                        {% endif %}
                                        <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-full">
                                            GIF
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file text-gray-400 text-2xl"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-16">
                <div class="w-20 h-20 bg-notion-sidebar rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-inbox text-notion-text text-3xl"></i>
                </div>
                <h3 class="text-lg font-medium text-notion-gray mb-2">暂无笔记</h3>
                <p class="text-notion-text">
                    {% if search_query or start_date or end_date %}
                    没有找到符合条件的笔记，请尝试调整搜索条件
                    {% else %}
                    还没有任何笔记，开始保存一些内容吧
                    {% endif %}
                </p>
                {% if search_query or start_date or end_date %}
                <a href="{{ url_for('index') }}" class="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-notion-sidebar rounded-lg hover:bg-notion-hover transition-colors">
                    <i class="fas fa-arrow-left"></i>
                    返回全部笔记
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- 分页 -->
            {% if total_pages > 1 %}
            <div class="mt-8 flex justify-center">
                <nav class="flex items-center gap-2">
                    {% if current_page > 1 %}
                    <a href="{{ url_for('index', page=current_page - 1, search=search_query, start_date=start_date, end_date=end_date) }}" 
                       class="px-3 py-2 bg-white border border-notion-border rounded-lg hover:bg-notion-hover transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}
                    
                    {% for page_num in range(1, total_pages + 1) %}
                        {% if page_num == current_page %}
                        <span class="px-3 py-2 bg-gradient-to-r from-notion-blue to-teal-600 text-white rounded-lg font-medium">{{ page_num }}</span>
                        {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                        <a href="{{ url_for('index', page=page_num, search=search_query, start_date=start_date, end_date=end_date) }}" 
                           class="px-3 py-2 bg-white border border-notion-border rounded-lg hover:bg-notion-hover transition-colors">{{ page_num }}</a>
                        {% elif page_num == 4 or page_num == total_pages - 3 %}
                        <span class="px-3 py-2 text-notion-text">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if current_page < total_pages %}
                    <a href="{{ url_for('index', page=current_page + 1, search=search_query, start_date=start_date, end_date=end_date) }}" 
                       class="px-3 py-2 bg-white border border-notion-border rounded-lg hover:bg-notion-hover transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- 图片查看模态框 -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4" onclick="closeImageModal()">
        <div class="relative max-w-4xl max-h-full">
            <button class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-70 transition-all">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="" class="max-w-full max-h-full rounded-lg">
        </div>
    </div>

    <script>
        // 搜索面板切换
        function toggleSearch() {
            const panel = document.getElementById('searchPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                panel.classList.add('animate-slide-down');
                panel.querySelector('input[type="text"]').focus();
            }
        }

        // 清除搜索
        function clearSearch() {
            window.location.href = '{{ url_for("index") }}';
        }

        // 菜单切换（移动端）
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // 文本展开/收起
        function toggleText(noteId) {
            const textElement = document.getElementById(`text-${noteId}`);
            const toggleElement = document.getElementById(`toggle-${noteId}`);
            
            if (textElement.classList.contains('line-clamp-3')) {
                textElement.classList.remove('line-clamp-3');
                toggleElement.innerHTML = '收起文本<i class="fas fa-chevron-up ml-1"></i>';
            } else {
                textElement.classList.add('line-clamp-3');
                toggleElement.innerHTML = '展开全文<i class="fas fa-chevron-down ml-1"></i>';
            }
        }

        // 图片模态框
        function openImageModal(imageSrc, filename) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modalImage.alt = filename;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 确认删除
        function confirmDelete(noteId) {
            if (confirm('确定要删除这条笔记吗？此操作不可恢复。')) {
                fetch(`/delete_note/${noteId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const card = document.querySelector(`[data-note-id="${noteId}"]`);
                        card.style.transition = 'all 0.3s ease-out';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            card.remove();
                        }, 300);
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                const searchPanel = document.getElementById('searchPanel');
                if (!searchPanel.classList.contains('hidden')) {
                    searchPanel.classList.add('hidden');
                }
            }
            if (e.key === '/' && e.ctrlKey) {
                e.preventDefault();
                toggleSearch();
            }
        });

        // 页面加载动画
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.notion-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 50);
            });
        });
    </script>
</body>
</html>